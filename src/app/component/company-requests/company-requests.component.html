<div class="header">
  <h2>Списък с заявления</h2>
  <mat-form-field class="search-bar" appearance="outline">
    <mat-label>Търсене</mat-label>
    <input matInput (keyup)="onSearch($event)" placeholder="Търсене по стока, услуга, ключова дума..." />
  </mat-form-field>
</div>
<div class="listing-container">
  <mat-card class="listing-card" *ngFor="let request of companyRequests">
    <div class="card-content">
      <div class="image" *ngIf="request.pictures && request.pictures.length > 0">
        <img [src]="request.pictures[0]" alt="Image" />
      </div>
      <div class="info">
        <div class="title-section">
          <h3>{{ request.title }}</h3>
          <span class="price">{{ request.description }}</span>
          <div class="request-type right-align">
            <mat-icon>campaign</mat-icon>
            <span>{{ request.requestType | requestTypeTranslate:'bg' }}</span>
          </div>
        </div>
        <p class="description">{{ request.description }}</p>
        <div class="company">
          <mat-icon>business</mat-icon> {{ request.requesterName }} <span *ngIf="request.requesterCompanyId">({{ request.requesterCompanyId }})</span>
        </div>
        <div class="actions">
          <button mat-stroked-button color="primary" (click)="viewRequestDetails(request.id)" [disabled]="showReplyFormId === request.id">Виж</button>
          <button mat-stroked-button color="accent" (click)="onReply(request)" [class.active-reply]="showReplyFormId === request.id">Отговори</button>
          <button mat-stroked-button color="warn" (click)="onSave(request)" [disabled]="showReplyFormId === request.id">Запази</button>
        </div>
        <div *ngIf="showReplyFormId === request.id" class="reply-form">
          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Компания</mat-label>
            <mat-select [(ngModel)]="replyFormData[request.id].responserVatNumber" required>
              <mat-option [value]="''">-- Избери компания --</mat-option>
              <mat-option *ngFor="let company of userCompanies" [value]="company.vatNumber">
                {{ company.name }} ({{ company.vatNumber }})
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="fill" style="width: 100%; margin-top: 16px;">
            <mat-label>Отговор</mat-label>
            <textarea matInput [(ngModel)]="replyFormData[request.id].responseText" rows="4" required></textarea>
          </mat-form-field>
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button mat-raised-button color="primary" (click)="onSubmitReply(request)">Отговори</button>
            <button mat-button color="warn" (click)="onCancelReply()">Отказ</button>
          </div>
        </div>
      </div>
    </div>
  </mat-card>
</div>

<mat-paginator
  [length]="totalRequests"
  [pageSize]="pageSize"
  [pageSizeOptions]="[10, 20, 50]"
  (page)="onPageChange($event)">
</mat-paginator>