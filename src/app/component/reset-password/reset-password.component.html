<div class="reset-password-container">
  <div class="reset-password-card">
    <div class="card-header">
      <mat-icon class="header-icon">vpn_key</mat-icon>
      <h1>Нова парола</h1>
      @if(!tokenInvalid){
      <p class="subtitle">
        Въведете вашата нова парола. Уверете се, че е силна и сигурна.
      </p>
      }
    </div>

    <div *ngIf="tokenInvalid" class="error-message">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h2>Невалиден линк</h2>
      <p>
        Линкът за възстановяване на паролата е невалиден или е изтекъл.
        Моля, заявете нов линк за възстановяване.
      </p>
      <button mat-raised-button color="primary" (click)="goToForgotPassword()">
        Заявете нов линк
      </button>
    </div>

    @if(!tokenInvalid){
    <div class="card-content">
      <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()">
        <!-- Password Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Нова парола</mat-label>
          <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password"
            placeholder="Минимум 8 символа">
          <mat-icon matPrefix>lock</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword"
            [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hidePassword">
            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="passwordControl?.hasError('required')">
            Паролата е задължителна
          </mat-error>
          <mat-error *ngIf="passwordControl?.hasError('minlength')">
            Минимум 8 символа
          </mat-error>
          <mat-error *ngIf="passwordControl?.hasError('maxlength')">
            Максимум 100 символа
          </mat-error>
        </mat-form-field>

        <!-- Password Requirements -->
        <div class="password-requirements" *ngIf="passwordControl?.value">
          <div class="requirement" [class.valid]="!hasPasswordError('hasLowerCase')">
            <mat-icon>{{hasPasswordError('hasLowerCase') ? 'close' : 'check'}}</mat-icon>
            <span>Една малка буква</span>
          </div>
          <div class="requirement" [class.valid]="!hasPasswordError('hasUpperCase')">
            <mat-icon>{{hasPasswordError('hasUpperCase') ? 'close' : 'check'}}</mat-icon>
            <span>Една главна буква</span>
          </div>
          <div class="requirement" [class.valid]="!hasPasswordError('hasNumeric')">
            <mat-icon>{{hasPasswordError('hasNumeric') ? 'close' : 'check'}}</mat-icon>
            <span>Една цифра</span>
          </div>
          <div class="requirement" [class.valid]="!hasPasswordError('hasSpecial')">
            <mat-icon>{{hasPasswordError('hasSpecial') ? 'close' : 'check'}}</mat-icon>
            <span>Един специален символ (!@#$%^&*...)</span>
          </div>
        </div>

        <!-- Confirm Password Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Потвърдете паролата</mat-label>
          <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword"
            placeholder="Въведете паролата отново">
          <mat-icon matPrefix>lock_outline</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="hideConfirmPassword = !hideConfirmPassword"
            [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hideConfirmPassword">
            <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="confirmPasswordControl?.hasError('required')">
            Потвърждението е задължително
          </mat-error>
          <mat-error *ngIf="confirmPasswordControl?.hasError('passwordMismatch')">
            Паролите не съвпадат
          </mat-error>
        </mat-form-field>

        <button mat-raised-button color="primary" type="submit" class="submit-button"
          [disabled]="isLoading || resetPasswordForm.invalid">
          <mat-icon *ngIf="!isLoading">check</mat-icon>
          <mat-icon *ngIf="isLoading" class="spinning">refresh</mat-icon>
          {{ isLoading ? 'Запазване...' : 'Запази новата парола' }}
        </button>

        <div class="back-to-login">
          <button mat-button type="button" (click)="goToLogin()">
            <mat-icon>arrow_back</mat-icon>
            Обратно към вход
          </button>
        </div>
      </form>
    </div>
    }
  </div>

</div>