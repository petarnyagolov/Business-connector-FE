<div *ngIf="request; else loading">
  <mat-card class="example-card" appearance="outlined" style="max-width: 500px; margin: 0 auto; box-shadow: 0 2px 12px #0002; border-radius: 14px;">
    <mat-card-header>
      <mat-icon mat-card-avatar color="primary" style="background: #e3f2fd; border-radius: 50%;">campaign</mat-icon>
      <mat-card-title style="font-weight: 600; font-size: 1.2rem;">{{ request.title }}</mat-card-title>
      <mat-card-subtitle style="font-size: 0.95rem; color: #1976d2;">{{ request.requesterName | uppercase }}</mat-card-subtitle>
    </mat-card-header>
    <div *ngIf="request.requesterCompanyId" style="display: flex; align-items: center; margin-left: 16px; margin-bottom: 4px; color: #607d8b; font-size: 0.98rem;">
      <mat-icon style="font-size: 18px; margin-right: 6px;">business</mat-icon>
      <span class="label">Фирма:&nbsp;</span>
      <span class="value" style="margin-left: 4px; font-weight: 500;">
        <ng-container *ngIf="requesterCompany; else showCompanyId">
          {{ requesterCompany.name }}
        </ng-container>
        <ng-template #showCompanyId>
          {{ request.requesterCompanyId }}
        </ng-template>
      </span>
    </div>
    <mat-card-content>
      <div class="request-details" style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px;">
        <div *ngIf="request.description" style="display: flex; flex-direction: column;">
          <div style="display: flex; align-items: center;">
            <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">description</mat-icon>
            <span class="label">Описание:</span>
          </div>
          <div style="padding-left: 30px; margin-top: 4px;">
            <span class="value">{{ request.description }}</span>
          </div>
        </div>
        <div *ngIf="request.requestType" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">category</mat-icon>
          <span class="label">Тип:&nbsp;</span>
          <span class="value">
            {{ request.requestType === 'LOOKING_FOR_SERVICE' ? 'Търся услуга' :
               request.requestType === 'SHARE_SERVICE' ? 'Предлагам услуга' :
               request.requestType === 'BUY' ? 'Купувам' :
               request.requestType === 'SELL' ? 'Продавам' :
               request.requestType === 'OTHER' ? 'Друго' : request.requestType }}
          </span>
        </div>
        <div *ngIf="request.region" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">place</mat-icon>
          <span class="label">Регион:&nbsp;</span> <span class="value">{{ request.region }}</span>
        </div>
        <div *ngIf="request.capacity" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">inventory_2</mat-icon>
          <span class="label">Количество:&nbsp;</span> <span class="value">{{ request.capacity }}{{ request.unit ? ' ' + getUnitLabel(request.unit) : '' }}</span>
        </div>
        <div *ngIf="request.serviceType" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">build</mat-icon>
          <span class="label">Тип услуга:&nbsp;</span> 
          <span class="value">
            {{ request.serviceType === 'one_time' ? 'Еднократна' : (request.serviceType === 'permanent' ? 'Постоянна' : request.serviceType) }}
          </span>
        </div>
        <div *ngIf="request.priceFrom || request.priceTo" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">euro_symbol</mat-icon>
          <span class="label">Цена:&nbsp;</span>
          <span class="value">
            <ng-container *ngIf="request.priceFrom">от {{ request.priceFrom }}</ng-container>
            <ng-container *ngIf="request.priceTo">&nbsp;до {{ request.priceTo }}</ng-container>
          </span>
        </div>
        <div *ngIf="request.workMode && request.workMode !== 'nomatter'" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">work</mat-icon>
          <span class="label">Режим:&nbsp;</span> 
          <span class="value">
            {{ request.workMode === 'standard' ? 'Стандартно делнично' :
               request.workMode === 'extended' ? 'Удължено' :
               request.workMode === 'continuous' ? 'Непрекъснато' : request.workMode }}
          </span>
        </div>
        <div *ngIf="request.urgent !== undefined" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">priority_high</mat-icon>
          <span class="label">Спешно:&nbsp;</span> <span class="value">{{ request.urgent ? 'Да' : 'Не' }}</span>
        </div>
        <div *ngIf="request.availableFrom || request.availableTo" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">event</mat-icon>
          <span class="label">Период:&nbsp;</span>
          <span class="value">
            <ng-container *ngIf="request.availableFrom">от {{ formatDateArray(request.availableFrom) }}</ng-container>
            <ng-container *ngIf="request.availableTo"> &nbsp;до {{ formatDateArray(request.availableTo) }}</ng-container>
          </span>
        </div>
        <div *ngIf="request.files && request.files.length" class="files-row" style="display: flex; align-items: flex-start; margin-top: 8px;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b; margin-top: 2px;">attach_file</mat-icon>
          <span class="label" style="margin-right: 6px;">Файлове:</span>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
            <ng-container *ngFor="let file of request.files">
              <div *ngIf="file.isImage" style="display: block; text-decoration: none;">
                <img [src]="file.url" [alt]="file.name" 
                     (click)="openImageModal(file.url, request)" 
                     style="max-width: 120px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #0002; object-fit: cover; border: 1px solid #e0e0e0; margin-bottom: 4px; cursor: pointer;" />
              </div>
              <div *ngIf="!file.isImage"
                 (click)="openPdfInNewTab(file.url)"
                 style="display: flex; align-items: center; padding: 6px 12px; background-color: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; color: #333; text-decoration: none; margin-bottom: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;">
                <mat-icon style="color: #f44336; margin-right: 8px;">picture_as_pdf</mat-icon>
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;">{{ file.name }}</span>
              </div>
            </ng-container>
          </div>
        </div>
        
        <div *ngIf="(!request.files || !request.files.length) && request.pictures && request.pictures.length" class="pictures-row" style="display: flex; align-items: flex-start; margin-top: 8px;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b; margin-top: 2px;">image</mat-icon>
          <span class="label" style="margin-right: 6px;">Снимки:</span>
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <ng-container *ngFor="let pic of request.pictures">
              <div style="display: block; text-decoration: none;">
                <img [src]="pic" alt="Снимка" 
                     (click)="openImageModal(pic, request)" 
                     style="max-width: 120px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #0002; object-fit: cover; border: 1px solid #e0e0e0; margin-bottom: 4px; cursor: pointer;" />
              </div>
            </ng-container>
          </div>
        </div>
        <!-- <div *ngIf="request.status" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">info</mat-icon>
          <span class="label">Статус:</span> <span class="value">{{ request.status }}</span>
        </div> -->
      </div>
    </mat-card-content>
    <mat-card-actions align="end">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="openResponseModal()"
        [disabled]="!canSubmitResponse()"
        [title]="isRequestOwner() ? 'Не можете да подавате оферта за ваша собствена публикация' : (!hasAvailableCompaniesForResponse() ? 'Всички ваши компании вече имат предложения' : 'Подай предложение')"
        style="margin: 8px;"
      >
        <mat-icon style="margin-right: 4px;">reply</mat-icon>
        Предложи
      </button>
    </mat-card-actions>
  </mat-card>
  <div *ngIf="responses && responses.length" style="margin: 24px auto 0 auto;">
    <h3 style="text-align: center; margin-bottom: 24px; color: #1976d2; display: flex; align-items: center; justify-content: center; gap: 8px;">
      <mat-icon color="primary">question_answer</mat-icon>
      Предложения ({{ responses.length }})
    </h3>
    
    <div class="responses-grid" style="display: flex; flex-wrap: wrap; gap: 24px; justify-content: center;">
      <mat-card class="response-card" *ngFor="let response of responses; let i = index" appearance="outlined" 
                style="width: 370px; min-width: 320px; max-width: 100%; box-shadow: 0 2px 12px #0002; border-radius: 14px; position: relative;"
                [style.opacity]="response.status === 'NOT_AVAILABLE' ? '0.6' : '1'"
                [style.background]="response.status === 'NOT_AVAILABLE' ? '#f5f5f5' : '#ffffff'">
        
        <div *ngIf="response.status === 'NOT_AVAILABLE'" 
             style="position: absolute; top: 10px; right: 10px; background: #9e9e9e; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; z-index: 10;">
          Оттеглено
        </div>
        
        <mat-card-header [style.opacity]="response.status === 'NOT_AVAILABLE' ? '0.7' : '1'">
          <mat-icon mat-card-avatar color="accent" style="background: #e8f5e8; border-radius: 50%;">reply</mat-icon>
          <mat-card-title style="font-weight: 600; font-size: 1.1rem;">Предложение #{{ response.id }}</mat-card-title>
          <mat-card-subtitle style="font-size: 0.95rem; color: #1976d2;">
            {{ getCompanyName(response.responserCompanyName) || 'Неизвестна фирма' }}
          </mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="response-details" style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px;">
            
            <div style="display: flex; align-items: flex-start;">
              <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b; margin-top: 2px;">message</mat-icon>
              <span class="label">Предложение:&nbsp;</span> 
              <span class="value" style="word-break: break-word;">{{ response.responseText }}</span>
            </div>
            
            <div *ngIf="response.fixedPrice" style="display: flex; align-items: center;">
              <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">euro_symbol</mat-icon>
              <span class="label">Фиксирана цена:&nbsp;</span> 
              <span class="value" style="font-weight: 500; color: #4caf50;">{{ response.fixedPrice }} €</span>
            </div>
            
            <div *ngIf="response.priceFrom || response.priceTo" style="display: flex; align-items: center;">
              <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">euro_symbol</mat-icon>
              <span class="label">Цена:&nbsp;</span>
              <span class="value" style="font-weight: 500; color: #4caf50;">
                <ng-container *ngIf="response.priceFrom">от {{ response.priceFrom }} €</ng-container>
                <ng-container *ngIf="response.priceTo">&nbsp;до {{ response.priceTo }} €</ng-container>
              </span>
            </div>
            
            <div *ngIf="response.availableFrom || response.availableTo" style="display: flex; align-items: center;">
              <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">event</mat-icon>
              <span class="label">Достъпност:&nbsp;</span>
              <span class="value">
                <ng-container *ngIf="response.availableFrom">от {{ formatDateArray(response.availableFrom) }}</ng-container>
                <ng-container *ngIf="response.availableTo"> &nbsp;до {{ formatDateArray(response.availableTo) }}</ng-container>
              </span>
            </div>
            
            <div *ngIf="response.files && response.files.length" class="files-row" style="display: flex; align-items: flex-start; margin-top: 8px;">
              <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b; margin-top: 2px;">attach_file</mat-icon>
              <span class="label" style="margin-right: 6px;">Файлове:</span>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
                <ng-container *ngFor="let file of response.files">
                  <div *ngIf="file.isImage" style="display: block; text-decoration: none;">
                    <img [src]="pictureBlobs[file.url] || file.url" [alt]="file.name" 
                         (click)="openImageModal(file.url, response)" 
                         style="max-width: 120px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #0002; object-fit: cover; border: 1px solid #e0e0e0; margin-bottom: 4px; cursor: pointer;" />
                  </div>
                  <div *ngIf="!file.isImage"
                       (click)="openPdfInNewTab(file.url)"
                       style="display: flex; align-items: center; padding: 6px 12px; background-color: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; color: #333; text-decoration: none; margin-bottom: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;">
                    <mat-icon style="color: #f44336; margin-right: 8px;">picture_as_pdf</mat-icon>
                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;">{{ file.name }}</span>
                  </div>
                </ng-container>
              </div>
            </div>
            
            <!-- Fallback за fileUrls ако няма files -->
            <div *ngIf="(!response.files || !response.files.length) && response.fileUrls && response.fileUrls.length" class="files-row" style="display: flex; align-items: flex-start; margin-top: 8px;">
              <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b; margin-top: 2px;">attach_file</mat-icon>
              <span class="label" style="margin-right: 6px;">Файлове:</span>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
                <ng-container *ngFor="let fileUrl of response.fileUrls">
                  <div *ngIf="isImageFile(fileUrl)" style="display: block; text-decoration: none;">
                    <img [src]="getFileUrl(fileUrl)" [alt]="getFileName(fileUrl)" 
                         (click)="openImageModalFromFileUrl(getFileUrl(fileUrl), response)" 
                         style="max-width: 120px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #0002; object-fit: cover; border: 1px solid #e0e0e0; margin-bottom: 4px; cursor: pointer;" />
                  </div>
                  <div *ngIf="!isImageFile(fileUrl)"
                       (click)="openPdfInNewTab(getFileUrl(fileUrl))"
                       style="display: flex; align-items: center; padding: 6px 12px; background-color: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; color: #333; text-decoration: none; margin-bottom: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;">
                    <mat-icon style="color: #f44336; margin-right: 8px;">picture_as_pdf</mat-icon>
                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;">{{ getFileName(fileUrl) }}</span>
                  </div>
                </ng-container>
              </div>
            </div>
            
          </div>
        </mat-card-content>
        
        <mat-card-actions style="display: flex; justify-content: center; gap: 8px;" [style.opacity]="response.status === 'NOT_AVAILABLE' ? '0.5' : '1'">
          <button *ngIf="canMakeDeal(response) && response.status !== 'NOT_AVAILABLE'" 
                  mat-stroked-button color="accent" (click)="openDealDialog(response)" 
                  style="font-size: 14px; padding: 10px 16px; min-width: 80px;">
            <mat-icon><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 -960 960 960"  fill="#005cbb" ><path d="M480-600 340-740l140-140 140 140-140 140ZM40-160v-160q0-34 23.5-57t56.5-23h131q20 0 38 10t29 27q29 39 71.5 61t90.5 22q49 0 91.5-22t70.5-61q13-17 30.5-27t36.5-10h131q34 0 57 23t23 57v160H640v-91q-35 25-75.5 38T480-200q-43 0-84-13.5T320-252v92H40Zm120-280q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T280-560q0 50-34.5 85T160-440Zm640 0q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T920-560q0 50-34.5 85T800-440Z"/></svg></mat-icon>
            Сделка
          </button>
          <button *ngIf="canEditResponse(response) && response.status !== 'NOT_AVAILABLE'" 
                  mat-stroked-button color="primary" (click)="editResponse(response)" 
                  style="font-size: 14px; padding: 10px 16px; min-width: 100px;">
            <mat-icon style="margin-right: 6px; font-size: 18px;">edit</mat-icon>
            Редактирай
          </button>
          <button *ngIf="canEditResponse(response)" 
                  mat-stroked-button color="warn" (click)="deleteResponse(response)" 
                  style="font-size: 14px; padding: 10px 16px; min-width: 80px;"
                  [disabled]="response.status === 'NOT_AVAILABLE'">
            <mat-icon style="margin-right: 6px; font-size: 18px;">delete</mat-icon>
            Изтрий
          </button>
          
          <div *ngIf="response.status === 'NOT_AVAILABLE'" style="display: flex; align-items: center; justify-content: center; color: #9e9e9e; font-style: italic; font-size: 14px; padding: 10px;">
            <mat-icon style="margin-right: 4px; font-size: 18px;">block</mat-icon>
            Предложението е оттеглено
          </div>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>



  <!-- Deal Confirmation Dialog -->
  <div *ngIf="showDealDialog && selectedResponse" class="deal-dialog-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; align-items: center; justify-content: center;">
    <div class="deal-dialog" style="background: #fff; padding: 24px; border-radius: 12px; min-width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin-bottom: 20px; color: #1976d2; display: flex; align-items: center; gap: 8px;">
        <mat-icon><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 -960 960 960"  fill="#005cbb" ><path d="M480-600 340-740l140-140 140 140-140 140ZM40-160v-160q0-34 23.5-57t56.5-23h131q20 0 38 10t29 27q29 39 71.5 61t90.5 22q49 0 91.5-22t70.5-61q13-17 30.5-27t36.5-10h131q34 0 57 23t23 57v160H640v-91q-35 25-75.5 38T480-200q-43 0-84-13.5T320-252v92H40Zm120-280q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T280-560q0 50-34.5 85T160-440Zm640 0q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T920-560q0 50-34.5 85T800-440Z"/></svg></mat-icon>

        Потвърждаване на сделката
      </h3>
      
      <div style="margin-bottom: 20px; padding: 16px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #1976d2;">
        <p style="margin: 0; font-weight: 500; color: #333;">Предложение от: {{ getCompanyName(selectedResponse.responserCompanyId) }}</p>
        <p style="margin: 8px 0 0 0; color: #666; font-size: 0.95em;">{{ selectedResponse.responseText }}</p>
        <div *ngIf="selectedResponse.fixedPrice" style="margin-top: 8px; color: #4caf50; font-weight: 500;">
          Фиксирана цена: {{ selectedResponse.fixedPrice }} €
        </div>
        <div *ngIf="selectedResponse.priceFrom || selectedResponse.priceTo" style="margin-top: 8px; color: #4caf50; font-weight: 500;">
          Цена: 
          <ng-container *ngIf="selectedResponse.priceFrom">от {{ selectedResponse.priceFrom }} €</ng-container>
          <ng-container *ngIf="selectedResponse.priceTo"> до {{ selectedResponse.priceTo }} €</ng-container>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;" [style.border-color]="dealFormData.confirmDeal ? '#1976d2' : '#e0e0e0'" [style.background-color]="dealFormData.confirmDeal ? '#f3f8ff' : '#fff'">
          <input type="checkbox" [(ngModel)]="dealFormData.confirmDeal" style="margin-right: 12px; transform: scale(1.2);">
          <span style="font-weight: 500; color: #333;">Искаш сделка с това предложение?</span>
        </label>

        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;" [style.border-color]="dealFormData.hidePublication ? '#1976d2' : '#e0e0e0'" [style.background-color]="dealFormData.hidePublication ? '#f3f8ff' : '#fff'">
          <input type="checkbox" [(ngModel)]="dealFormData.hidePublication" style="margin-right: 12px; transform: scale(1.2);">
          <span style="font-weight: 500; color: #333;">Искаш да скрием публикацията като завършена?</span>
        </label>

        <label style="display: flex; align-items: center; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;" [style.border-color]="dealFormData.startChat ? '#1976d2' : '#e0e0e0'" [style.background-color]="dealFormData.startChat ? '#f3f8ff' : '#fff'">
          <input type="checkbox" [(ngModel)]="dealFormData.startChat" style="margin-right: 12px; transform: scale(1.2);">
          <span style="font-weight: 500; color: #333;">Искаш да започнеш чат сесия за уточняване и размяна на контакти?</span>
        </label>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button mat-stroked-button color="primary" (click)="closeDealDialog()" style="min-width: 100px;">
          <mat-icon style="margin-right: 4px;">close</mat-icon>
          Отказ
        </button>
        <button mat-raised-button color="primary" (click)="submitDeal()" [disabled]="!canSubmitDeal()" style="min-width: 120px;">
            <mat-icon><svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 -960 960 960"  fill="#005cbb" ><path d="M480-600 340-740l140-140 140 140-140 140ZM40-160v-160q0-34 23.5-57t56.5-23h131q20 0 38 10t29 27q29 39 71.5 61t90.5 22q49 0 91.5-22t70.5-61q13-17 30.5-27t36.5-10h131q34 0 57 23t23 57v160H640v-91q-35 25-75.5 38T480-200q-43 0-84-13.5T320-252v92H40Zm120-280q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T280-560q0 50-34.5 85T160-440Zm640 0q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T920-560q0 50-34.5 85T800-440Z"/></svg></mat-icon>
          Потвърди сделката
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="showEditResponseDialog && editResponseData" class="edit-response-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; align-items: center; justify-content: center;">
    <div class="edit-response-dialog" style="background: #fff; padding: 24px 18px; border-radius: 12px; min-width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 2px 16px #0003;">
      <h3 style="margin-bottom: 18px; color: #1976d2;">Редакция на предложението</h3>
      
      <div style="display: flex; flex-direction: column; gap: 16px;">
        
        <mat-form-field appearance="fill" style="width: 100%;">
          <mat-label>Фирма</mat-label>
          <input matInput [value]="getCompanyName(editResponseData.responserCompanyId)" readonly style="background-color: #f5f5f5;">
        </mat-form-field>

        <mat-form-field appearance="fill" style="width: 100%;">
          <mat-label>Оригинално предложение</mat-label>
          <textarea matInput [value]="editResponseData.originalResponseText" readonly rows="3" style="background-color: #f5f5f5;"></textarea>
        </mat-form-field>

        <mat-form-field *ngIf="editResponseData.fixedPrice" appearance="fill" style="width: 100%;">
          <mat-label>Фиксирана цена</mat-label>
          <input matInput [value]="editResponseData.fixedPrice + ' €'" readonly style="background-color: #f5f5f5;">
        </mat-form-field>

        <div *ngIf="editResponseData.priceFrom || editResponseData.priceTo" style="display: flex; gap: 16px;">
          <mat-form-field *ngIf="editResponseData.priceFrom" appearance="fill" style="flex: 1;">
            <mat-label>Цена от</mat-label>
            <input matInput [value]="editResponseData.priceFrom + ' €'" readonly style="background-color: #f5f5f5;">
          </mat-form-field>
          <mat-form-field *ngIf="editResponseData.priceTo" appearance="fill" style="flex: 1;">
            <mat-label>Цена до</mat-label>
            <input matInput [value]="editResponseData.priceTo + ' €'" readonly style="background-color: #f5f5f5;">
          </mat-form-field>
        </div>

        <div *ngIf="editResponseData.availableFrom || editResponseData.availableTo" style="display: flex; gap: 16px;">
          <mat-form-field *ngIf="editResponseData.availableFrom" appearance="fill" style="flex: 1;">
            <mat-label>Достъпен от</mat-label>
            <input matInput [value]="formatDateArray(editResponseData.availableFrom)" readonly style="background-color: #f5f5f5;">
          </mat-form-field>
          <mat-form-field *ngIf="editResponseData.availableTo" appearance="fill" style="flex: 1;">
            <mat-label>Достъпен до</mat-label>
            <input matInput [value]="formatDateArray(editResponseData.availableTo)" readonly style="background-color: #f5f5f5;">
          </mat-form-field>
        </div>

        <div *ngIf="editResponseData.files && editResponseData.files.length" style="margin: 16px 0;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #1976d2;">Прикачени файлове:</label>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">
            <ng-container *ngFor="let file of editResponseData.files">
              <div *ngIf="file.isImage" style="position: relative;">
                <img [src]="pictureBlobs[file.url] || file.url" [alt]="file.name" 
                     style="max-width: 80px; max-height: 80px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd;" />
                <span style="position: absolute; bottom: -16px; left: 0; font-size: 10px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ file.name }}</span>
              </div>
              <div *ngIf="!file.isImage" style="display: flex; align-items: center; padding: 4px 8px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px;">
                <mat-icon style="color: #f44336; margin-right: 4px; font-size: 16px;">picture_as_pdf</mat-icon>
                <span style="font-size: 12px; max-width: 60px; overflow: hidden; text-overflow: ellipsis;">{{ file.name }}</span>
              </div>
            </ng-container>
          </div>
        </div>

        <mat-form-field appearance="fill" style="width: 100%;">
          <mat-label>Добавете към предложението</mat-label>
          <textarea matInput [(ngModel)]="editResponseData.additionalText" name="editAdditionalText" rows="3" 
                    placeholder="Въведете допълнителен текст, който ще се добави към оригиналното предложение..."></textarea>
          <mat-hint>Този текст ще се добави към съществуващото предложение</mat-hint>
        </mat-form-field>

      </div>

      <div style="display: flex; gap: 10px; margin-top: 18px; justify-content: flex-end;">
        <button mat-stroked-button color="primary" (click)="submitEditResponse()" [disabled]="!editResponseData.additionalText?.trim()">
          <mat-icon style="font-size: 20px; margin-right: 4px; color: #1976d2;">add</mat-icon>
          <span style="color: #1976d2;">Добави текст</span>
        </button>
        <button mat-stroked-button color="primary" (click)="closeEditResponseDialog()">
          <mat-icon style="font-size: 20px; margin-right: 4px; color: #1976d2;">close</mat-icon>
          <span style="color: #1976d2;">Отказ</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showImageDialog" class="image-dialog-overlay" (click)="closeImageDialog()" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
  <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 90vw; max-width: 1200px;" (click)="$event.stopPropagation()">
    <button *ngIf="imageFiles.length > 1" mat-icon-button (click)="previousImage()" style="position: absolute; left: -60px; background: rgba(255,255,255,0.7); width: 50px; height: 50px; border-radius: 50%;" color="primary">
      <mat-icon style="font-size: 30px;">chevron_left</mat-icon>
    </button>
    
    <div style="position: relative;">
      <img [src]="selectedImage" alt="Голямо изображение" style="max-width: 90vw; max-height: 90vh; border-radius: 12px; box-shadow: 0 4px 32px #0008; background: #fff; padding: 8px;" />
      
      <div *ngIf="imageFiles.length > 1" style="position: absolute; bottom: 20px; left: 0; right: 0; text-align: center;">
        <span style="background: rgba(0,0,0,0.5); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">
          {{ currentImageIndex + 1 }} / {{ imageFiles.length }}
        </span>
      </div>
    </div>
    
    <button *ngIf="imageFiles.length > 1" mat-icon-button (click)="nextImage()" style="position: absolute; right: -60px; background: rgba(255,255,255,0.7); width: 50px; height: 50px; border-radius: 50%;" color="primary">
      <mat-icon style="font-size: 30px;">chevron_right</mat-icon>
    </button>
  </div>
  
  <button mat-fab color="warn" (click)="closeImageDialog()" style="position: absolute; top: 32px; right: 48px; background: #fff; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 2px 8px #0003; cursor: pointer; font-size: 1.5rem; color: #1976d2; min-width: 0; min-height: 0; line-height: 1; padding: 0; display: flex; align-items: center; justify-content: center;">
    <mat-icon>close</mat-icon>
  </button>
</div>

<div *ngIf="showSuccessModal" class="success-modal-overlay" (click)="closeSuccessModal()" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease-out;">
  <div class="success-modal-content" (click)="$event.stopPropagation()" style="background: white; border-radius: 16px; min-width: 400px; max-width: 90vw; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideInScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);">
    
    <div style="padding: 24px 24px 16px 24px; text-align: center; border-bottom: 1px solid #f0f0f0;">
      <div style="width: 60px; height: 60px; margin: 0 auto 16px; background: linear-gradient(135deg, #4caf50, #45a049); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: bounceIn 0.6s ease-out 0.2s both;">
        <mat-icon style="color: white; font-size: 28px; width: 28px; height: 28px;">
          {{ successModalData.title === 'Грешка' ? 'error' : (successModalData.title === 'Внимание' ? 'warning' : 'check_circle') }}
        </mat-icon>
      </div>
      <h3 style="margin: 0; font-size: 1.4rem; font-weight: 600; color: #333;">
        {{ successModalData.title }}
      </h3>
    </div>
    
    <div style="padding: 20px 24px;">
      <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #666; text-align: center;">
        {{ successModalData.message }}
      </p>
    </div>
    
    <div style="padding: 16px 24px 24px; text-align: center;">
      <button mat-raised-button 
              [color]="successModalData.title === 'Грешка' ? 'warn' : 'primary'" 
              (click)="closeSuccessModal()"
              style="min-width: 120px; font-weight: 500; border-radius: 8px; text-transform: none;">
        {{ successModalData.buttonText }}
      </button>
    </div>
  </div>
</div>

<div *ngIf="showConfirmModal" class="confirm-modal-overlay" (click)="closeConfirmModal(false)" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease-out;">
  <div class="confirm-modal-content" (click)="$event.stopPropagation()" style="background: white; border-radius: 16px; min-width: 400px; max-width: 90vw; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideInScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);">
    
    <div style="padding: 24px 24px 16px 24px; text-align: center; border-bottom: 1px solid #f0f0f0;">
      <div style="width: 60px; height: 60px; margin: 0 auto 16px; background: linear-gradient(135deg, #ff9800, #f57c00); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: bounceIn 0.6s ease-out 0.2s both;">
        <mat-icon style="color: white; font-size: 28px; width: 28px; height: 28px;">help</mat-icon>
      </div>
      <h3 style="margin: 0; font-size: 1.4rem; font-weight: 600; color: #333;">
        {{ confirmModalData.title }}
      </h3>
    </div>
    
    <div style="padding: 20px 24px;">
      <p style="margin: 0; font-size: 1rem; line-height: 1.6; color: #666; text-align: center;">
        {{ confirmModalData.message }}
      </p>
    </div>
    
    <div style="padding: 16px 24px 24px; text-align: center; display: flex; gap: 12px; justify-content: center;">
      <button mat-button 
              (click)="closeConfirmModal(false)"
              style="min-width: 100px; font-weight: 500; border-radius: 8px; text-transform: none;">
        {{ confirmModalData.cancelText }}
      </button>
      <button mat-raised-button 
              color="warn" 
              (click)="confirmAction()"
              style="min-width: 100px; font-weight: 500; border-radius: 8px; text-transform: none;">
        {{ confirmModalData.confirmText }}
      </button>
    </div>
  </div>
</div>

<style>
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideInScale {
    0% { 
      opacity: 0; 
      transform: scale(0.7) translateY(-20px); 
    }
    100% { 
      opacity: 1; 
      transform: scale(1) translateY(0); 
    }
  }
  
  @keyframes bounceIn {
    0% { 
      opacity: 0; 
      transform: scale(0.3); 
    }
    50% { 
      opacity: 1; 
      transform: scale(1.1); 
    }
    100% { 
      opacity: 1; 
      transform: scale(1); 
    }
  }
</style>


<ng-template #loading>
  <p>Зареждане...</p>
</ng-template>
