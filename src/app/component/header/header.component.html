<mat-toolbar color="primary" class="header-toolbar">
  <div class="logo-section">
    <a routerLink="/home" class="logo-button">
      <img src="/logo.png?v=2" class="app-logo" alt="Logo" />
    </a>
  </div>

  <div class="desktop-nav">
    <div class="nav-links">
      <a mat-button routerLink="/home">Начало</a>
      @if (isAuthenticated) {
      <a mat-button routerLink="/requests">Публикации</a>
      <a mat-button routerLink="/user/companies">Моите фирми</a>
      <a mat-button routerLink="/my-requests">Моите Публикации</a>
      <a mat-button routerLink="/my-responses">Моите Предложения</a>
      <a mat-button routerLink="/saved-requests">
        <mat-icon style="margin-right: 4px; font-size: 18px;" [matBadge]="savedRequestsCount"
          [matBadgeHidden]="savedRequestsCount === 0" matBadgeColor="accent" matBadgeSize="small" aria-hidden="false"
          [attr.aria-label]="'Запазени публикации: ' + savedRequestsCount">
          bookmark
        </mat-icon>
        Запазени
      </a>
      }
    </div>

    @if (isAuthenticated) {
    <div class="user-actions">
      <!-- Real-time Notification Bell -->
      <app-notification-bell></app-notification-bell>

      <button mat-icon-button [matMenuTriggerFor]="accountMenu">
        <mat-icon>account_circle</mat-icon>
      </button>
      <mat-menu #accountMenu="matMenu" class="account-menu">
        <div style="padding: 16px; border-bottom: 1px solid #e0e0e0; margin-bottom: 8px; outline: none;" (click)="$event.stopPropagation()">
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
              <mat-icon style="margin-right: 8px; vertical-align: middle;">person</mat-icon>
              <span>{{ userName || 'Потребител' }}</span>
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
              {{ userEmail }}
            </div>
            <div style="font-size: 14px; color: #2e7d32; font-weight: 500;">
              <mat-icon
                style="margin-right: 8px; vertical-align: middle; font-size: 16px;">account_balance_wallet</mat-icon>
              <span>Кредити: {{ freeCredits }}</span>
            </div>
            @if (referralCode) {
            <div style="font-size: 14px; color: #1565c0; font-weight: 500; margin-top: 4px; cursor: pointer; display: flex; align-items: center;"
                 (click)="copyReferralCode(); $event.stopPropagation()"
                 matTooltip="Натисни за да копираш">
              <mat-icon
                style="margin-right: 8px; font-size: 16px; height: 16px; width: 16px;">loyalty</mat-icon>
              <span>Код: {{ referralCode }}</span>
            </div>
            }
          </div>
        </div>

        <button mat-menu-item (click)="onBuyCredits()">
          <mat-icon color="accent">add_shopping_cart</mat-icon>
          <span>Купи кредити</span>
        </button>
        <mat-divider></mat-divider>

        <button mat-menu-item (click)="onInvoices()">
          <mat-icon>receipt_long</mat-icon>
          <span>Фактури</span>
        </button>
        <button mat-menu-item (click)="onSettings()">
          <mat-icon>settings</mat-icon>
          <span>Настройки</span>
        </button>
        <button mat-menu-item (click)="onLogout()">
          <mat-icon>logout</mat-icon>
          <span>Излез</span>
        </button>
      </mat-menu>
    </div>
    }

    @if (!isAuthenticated) {<div class="auth-buttons">
      <a mat-button routerLink="/login" class="modern-login-btn" style="position: relative !important; 
                color: white !important; 
                border: 1px solid rgba(255, 255, 255, 0.6) !important; 
                background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)) !important; 
                backdrop-filter: blur(20px) !important; 
                -webkit-backdrop-filter: blur(20px) !important; 
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3) !important; 
                border-radius: 12px !important; 
                overflow: hidden !important; 
                min-width: 80px !important; 
                height: 40px !important; 
                transition: all 0.3s ease !important;">Влез</a>
      <a mat-raised-button color="accent" routerLink="/register">Регистрация</a>
    </div>
    }
  </div>


  <div class="mobile-nav">
    <button mat-icon-button (click)="toggleMobileMenu()" class="mobile-menu-btn">
      <mat-icon>{{ isMobileMenuOpen ? 'close' : 'menu' }}</mat-icon>
    </button>
  </div>
</mat-toolbar>

@if (isMobileMenuOpen) {
<div class="mobile-menu-overlay" (click)="closeMobileMenu()">
  <div class="mobile-menu-content" (click)="$event.stopPropagation()">

    @if (isAuthenticated) {
    <div class="mobile-user-info">
      <div class="mobile-user-details">
        <mat-icon class="user-avatar">account_circle</mat-icon>
        <div class="mobile-user-text">
          <div class="mobile-user-name">{{ userName || 'Потребител' }}</div>
          <div class="mobile-user-email">{{ userEmail }}</div>
          <div class="mobile-user-credits">
            <mat-icon>account_balance_wallet</mat-icon>
            Кредити: {{ freeCredits }}
          </div>
          @if (referralCode) {
          <div class="mobile-user-credits" style="color: #1565c0; cursor: pointer;"
               (click)="copyReferralCode()">
            <mat-icon>loyalty</mat-icon>
            Код: {{ referralCode }} (Натисни за копиране)
          </div>
          }
        </div>
      </div>
    </div>
    }

    @if (isAuthenticated) {
    <mat-divider></mat-divider>
    }

    <div class="mobile-nav-links">
      <button mat-button routerLink="/home" (click)="closeMobileMenu()">
        <mat-icon>home</mat-icon>
        Начало
      </button>

      @if (isAuthenticated) {
      <ng-container>
        <button mat-button routerLink="/requests" (click)="closeMobileMenu()">
          <mat-icon>business</mat-icon>
          Публикации
        </button>
        <button mat-button routerLink="/user/companies" (click)="closeMobileMenu()">
          <mat-icon>domain</mat-icon>
          Моите фирми
        </button>
        <button mat-button routerLink="/my-requests" (click)="closeMobileMenu()">
          <mat-icon>post_add</mat-icon>
          Моите Публикации
        </button>
        <button mat-button routerLink="/my-responses" (click)="closeMobileMenu()">
          <mat-icon>reply</mat-icon>
          Моите Предложения
        </button>
        <button mat-button routerLink="/saved-requests" (click)="closeMobileMenu()">
          <mat-icon [matBadge]="savedRequestsCount" [matBadgeHidden]="savedRequestsCount === 0" matBadgeColor="accent"
            aria-hidden="false" [attr.aria-label]="'Запазени публикации: ' + savedRequestsCount">
            bookmark
          </mat-icon>
          Запазени
        </button>
      </ng-container>
      }

      <button mat-button routerLink="/about" (click)="closeMobileMenu()">
        <mat-icon>info</mat-icon>
        За нас
      </button>
    </div>


    @if (isAuthenticated) {
    <mat-divider></mat-divider>
    }

    @if (isAuthenticated) {
    <div class="mobile-user-actions">
      <button mat-button (click)="onBuyCredits()">
        <mat-icon>add_shopping_cart</mat-icon>
        Купи кредити
      </button>

      <button mat-button routerLink="/notifications" (click)="closeMobileMenu()">
        <mat-icon>notifications</mat-icon>
        Известия
      </button>

      <mat-divider></mat-divider>

      <button mat-button (click)="onInvoices()">
        <mat-icon>receipt_long</mat-icon>
        Фактури
      </button>

      <button mat-button (click)="onSettings()">
        <mat-icon>settings</mat-icon>
        Настройки
      </button>

      <button mat-button (click)="onLogout()" class="mobile-logout-btn">
        <mat-icon>logout</mat-icon>
        Излез
      </button>
    </div>
    }

    @if (!isAuthenticated) {
    <div class="mobile-auth-actions">
      <button mat-button routerLink="/login" (click)="closeMobileMenu()">
        <mat-icon>login</mat-icon>
        Влез
      </button>
      <button mat-raised-button color="accent" routerLink="/register" (click)="closeMobileMenu()">
        <mat-icon>person_add</mat-icon>
        Регистрация
      </button>
    </div>
    }
  </div>
</div>
}

@if (showBuyCreditsModal) {
<ng-container>
  <div class="modal-overlay" (click)="closeBuyCreditsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Купи кредити</h2>
        <button mat-icon-button (click)="closeBuyCreditsModal()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body">
        <div class="credit-packages">
          <h3>Избери от промоционалните пакети:</h3>

          <mat-form-field appearance="outline" class="package-select">
            <mat-label>Изберете пакет</mat-label>
            <mat-select [(ngModel)]="selectedPackage" name="packageSelect" placeholder="Изберете пакет"
              (selectionChange)="onPackageChange($event)">
              @for (pkg of creditPackages; track pkg.id) {
              <mat-option [value]="pkg">
                {{ pkg.credits }} кредита - {{ pkg.priceWithVat }} {{ pkg.currency }}
                @if (pkg.name) {
                <span> - {{ pkg.name }}</span>
                }
              </mat-option>
              } </mat-select>
          </mat-form-field>

          @if (selectedPackage) {
          <div class="selected-package">
            <div class="package-details">
              <h4>Избран пакет:</h4>
              <div class="package-info">
                <mat-icon color="accent">stars</mat-icon>
                <span>
                  {{ selectedPackage.credits }} кредита за
                  {{ selectedPackage.priceWithVat }} {{ selectedPackage.currency }}
                </span>
              </div>
              @if (selectedPackage.description) {
              <p class="package-description">{{ selectedPackage.description }}
              </p>
              }
            </div>
          </div>
          }
          @if (selectedPackage) {
          <div class="payment-section">
            <h3>Начин на плащане</h3>
            
            <mat-radio-group [(ngModel)]="paymentMethod" class="payment-method-group">
              <mat-radio-button value="card" class="payment-option">
                <div class="payment-option-content">
                  <mat-icon color="accent">credit_card</mat-icon>
                  <div class="payment-option-text">
                    <strong>Банкова карта</strong>
                    <span>Директно плащане с дебитна/кредитна карта</span>
                  </div>
                </div>
              </mat-radio-button>
              
              <mat-radio-button value="bank" class="payment-option">
                <div class="payment-option-content">
                  <mat-icon>account_balance</mat-icon>
                  <div class="payment-option-text">
                    <strong>Банков превод</strong>
                    <span>Плащане чрез банков превод</span>
                  </div>
                </div>
              </mat-radio-button>
            </mat-radio-group>
            
            <div class="payment-info">
              <mat-icon>info</mat-icon>
              <p>
                @if (paymentMethod === 'card') {
                  След потвърждение ще бъдете пренасочени към защитената платежна страница на ePay.bg,
                  където ще въведете данните за плащане.
                } @else {
                  Ще получите PDF с банкови детайли за превод. След извършване на плащането, кредитите ще бъдат добавени автоматично.
                }
              </p>
            </div>
          </div>
          }

          <div class="invoice-section">
            <h3>Данни за фактура</h3>

            @if (userCompanies.length > 0) {
            <mat-form-field appearance="outline" class="full-width company-select">
              <mat-label>Фирма за фактура</mat-label>
              <mat-select [(ngModel)]="selectedCompanyId" name="invoiceCompany"
                          (selectionChange)="onCompanySelected($event.value)">
                @for (company of userCompanies; track company.id) {
                <mat-option [value]="company.id">{{ company.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            }

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Име/Фирма за фактура</mat-label>
              <input matInput [(ngModel)]="invoiceName" name="invoiceName" required (ngModelChange)="onInvoiceDataChange()">
            </mat-form-field>

            <div class="invoice-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>ЕИК/Булстат</mat-label>
                <input matInput [(ngModel)]="invoiceBulstat" name="invoiceBulstat" (ngModelChange)="onInvoiceDataChange()">
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>ДДС номер</mat-label>
                <input matInput [(ngModel)]="invoiceVatNumber" name="invoiceVatNumber" (ngModelChange)="onInvoiceDataChange()">
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Адрес за фактура</mat-label>
              <input matInput [(ngModel)]="invoiceAddress" name="invoiceAddress" (ngModelChange)="onInvoiceDataChange()">
            </mat-form-field>

            <div class="invoice-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Имейл за фактура</mat-label>
                <input matInput [(ngModel)]="invoiceEmail" name="invoiceEmail" type="email" (ngModelChange)="onInvoiceDataChange()">
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>МОЛ</mat-label>
                <input matInput [(ngModel)]="invoiceMol" name="invoiceMol" (ngModelChange)="onInvoiceDataChange()">
              </mat-form-field>
            </div>
            
            @if (invoiceDataChanged && selectedCompanyId) {
            <div class="invoice-save-section">
              <button mat-raised-button color="accent" (click)="saveInvoiceData()" [disabled]="isSavingInvoiceData || !invoiceName">
                <mat-icon>save</mat-icon>
                {{ isSavingInvoiceData ? 'Запазване...' : 'Запази данните за фактура' }}
              </button>
            </div>
            }
            
            @if (proformaDownloaded) {
            <div class="proforma-status">
              <mat-icon color="accent">check_circle</mat-icon>
              <span>Проформа фактура изтеглена. Натиснете "Купи" за продължаване към плащане.</span>
            </div>
            }
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button mat-button (click)="closeBuyCreditsModal()">Затвори</button>
        <button mat-raised-button color="primary" [disabled]="!selectedPackage || isProcessingPurchase || !invoiceName"
          (click)="processPurchase()">
          @if (proformaDownloaded) {
            <mat-icon>payment</mat-icon>
          } @else {
            <mat-icon>download</mat-icon>
          }
          {{ proformaDownloaded ? 'Към плащане' : 'Изтегли проформа' }}
        </button>
      </div>
    </div>
  </div>
</ng-container>
}