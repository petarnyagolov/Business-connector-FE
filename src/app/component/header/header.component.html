<mat-toolbar color="primary" class="header-toolbar">
  <div class="logo-section">
    <a routerLink="/home" class="logo-button">
      <img src="/logo.png?v=2" class="app-logo" alt="Logo" />
    </a>
  </div>

  <div class="desktop-nav">
    <div class="nav-links">
      <a mat-button routerLink="/home">Начало</a>
      <a mat-button routerLink="/requests" *ngIf="isAuthenticated">Публикации</a>
      <a mat-button routerLink="/user/companies" *ngIf="isAuthenticated">Моите фирми</a>
      <a mat-button routerLink="/my-requests" *ngIf="isAuthenticated">Моите Публикации</a>
      <a mat-button routerLink="/my-responses" *ngIf="isAuthenticated">Моите Предложения</a>
      <a mat-button routerLink="/saved-requests" *ngIf="isAuthenticated">
        <mat-icon 
          style="margin-right: 4px; font-size: 18px;" 
          [matBadge]="savedRequestsCount" 
          [matBadgeHidden]="savedRequestsCount === 0"
          matBadgeColor="accent"
          matBadgeSize="small"
          aria-hidden="false"
          [attr.aria-label]="'Запазени публикации: ' + savedRequestsCount">
          bookmark
        </mat-icon>
        Запазени
      </a>
    </div>

    <div class="user-actions" *ngIf="isAuthenticated">
      <!-- Real-time Notification Bell -->
      <app-notification-bell></app-notification-bell>
      
      <button mat-icon-button [matMenuTriggerFor]="accountMenu">
        <mat-icon>account_circle</mat-icon>
      </button>
      <mat-menu #accountMenu="matMenu" class="account-menu">
        <div mat-menu-item disabled style="white-space: normal; opacity: 1; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 8px;">
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
              <mat-icon style="margin-right: 8px; vertical-align: middle;">person</mat-icon>
              <span>{{ userName || 'Потребител' }}</span>
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
              {{ userEmail }}
            </div>
            <div style="font-size: 14px; color: #2e7d32; font-weight: 500;">
              <mat-icon style="margin-right: 8px; vertical-align: middle; font-size: 16px;">account_balance_wallet</mat-icon>
              <span>Кредити: {{ freeCredits }}</span>
            </div>
          </div>
        </div>
        
        <button mat-menu-item (click)="onBuyCredits()">
          <mat-icon color="accent">add_shopping_cart</mat-icon>
          <span>Купи кредити</span>
        </button>
        <mat-divider></mat-divider>
        
        <button mat-menu-item (click)="onInvoices()">
          <mat-icon>receipt_long</mat-icon>
          <span>Фактури</span>
        </button>
        <button mat-menu-item (click)="onSettings()">
          <mat-icon>settings</mat-icon>
          <span>Настройки</span>
        </button>
        <button mat-menu-item (click)="onLogout()">
          <mat-icon>logout</mat-icon>
          <span>Излез</span>
        </button>
      </mat-menu>
    </div>

    <div class="auth-buttons" *ngIf="!isAuthenticated">
      <a mat-button routerLink="/login" 
         class="modern-login-btn"
         style="position: relative !important; 
                color: white !important; 
                border: 1px solid rgba(255, 255, 255, 0.6) !important; 
                background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)) !important; 
                backdrop-filter: blur(20px) !important; 
                -webkit-backdrop-filter: blur(20px) !important; 
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3) !important; 
                border-radius: 12px !important; 
                overflow: hidden !important; 
                min-width: 80px !important; 
                height: 40px !important; 
                transition: all 0.3s ease !important;">Влез</a>
      <a mat-raised-button color="accent" routerLink="/register">Регистрация</a>
    </div>
  </div>

  <div class="mobile-nav">
    <button mat-icon-button (click)="toggleMobileMenu()" class="mobile-menu-btn">
      <mat-icon>{{ isMobileMenuOpen ? 'close' : 'menu' }}</mat-icon>
    </button>
  </div>
</mat-toolbar>

<div class="mobile-menu-overlay" *ngIf="isMobileMenuOpen" (click)="closeMobileMenu()">
  <div class="mobile-menu-content" (click)="$event.stopPropagation()">
    
    <div class="mobile-user-info" *ngIf="isAuthenticated">
      <div class="mobile-user-details">
        <mat-icon class="user-avatar">account_circle</mat-icon>
        <div class="mobile-user-text">
          <div class="mobile-user-name">{{ userName || 'Потребител' }}</div>
          <div class="mobile-user-email">{{ userEmail }}</div>
          <div class="mobile-user-credits">
            <mat-icon>account_balance_wallet</mat-icon>
            Кредити: {{ freeCredits }}
          </div>
        </div>
      </div>
    </div>

    <mat-divider *ngIf="isAuthenticated"></mat-divider>

    <div class="mobile-nav-links">
      <button mat-button routerLink="/home" (click)="closeMobileMenu()">
        <mat-icon>home</mat-icon>
        Начало
      </button>
      
      <ng-container *ngIf="isAuthenticated">
        <button mat-button routerLink="/requests" (click)="closeMobileMenu()">
          <mat-icon>business</mat-icon>
          Публикации
        </button>
        <button mat-button routerLink="/user/companies" (click)="closeMobileMenu()">
          <mat-icon>domain</mat-icon>
          Моите фирми
        </button>
        <button mat-button routerLink="/my-requests" (click)="closeMobileMenu()">
          <mat-icon>post_add</mat-icon>
          Моите Публикации
        </button>
        <button mat-button routerLink="/my-responses" (click)="closeMobileMenu()">
          <mat-icon>reply</mat-icon>
          Моите Предложения
        </button>
        <button mat-button routerLink="/saved-requests" (click)="closeMobileMenu()">
          <mat-icon 
            [matBadge]="savedRequestsCount" 
            [matBadgeHidden]="savedRequestsCount === 0" 
            matBadgeColor="accent"
            aria-hidden="false"
            [attr.aria-label]="'Запазени публикации: ' + savedRequestsCount">
            bookmark
          </mat-icon>
          Запазени
        </button>
      </ng-container>
      
      <button mat-button routerLink="/about" (click)="closeMobileMenu()">
        <mat-icon>info</mat-icon>
        За нас
      </button>
    </div>

    <mat-divider *ngIf="isAuthenticated"></mat-divider>

    <div class="mobile-user-actions" *ngIf="isAuthenticated">
      <button mat-button (click)="onBuyCredits()">
        <mat-icon>add_shopping_cart</mat-icon>
        Купи кредити
      </button>

      <button mat-button routerLink="/notifications" (click)="closeMobileMenu()">
        <mat-icon>notifications</mat-icon>
        Известия
      </button>

      <mat-divider></mat-divider>

      <button mat-button (click)="onInvoices()">
        <mat-icon>receipt_long</mat-icon>
        Фактури
      </button>

      <button mat-button (click)="onSettings()">
        <mat-icon>settings</mat-icon>
        Настройки
      </button>

      <button mat-button (click)="onLogout()" class="mobile-logout-btn">
        <mat-icon>logout</mat-icon>
        Излез
      </button>
    </div>

    <div class="mobile-auth-actions" *ngIf="!isAuthenticated">
      <button mat-button routerLink="/login" (click)="closeMobileMenu()">
        <mat-icon>login</mat-icon>
        Влез
      </button>
      <button mat-raised-button color="accent" routerLink="/register" (click)="closeMobileMenu()">
        <mat-icon>person_add</mat-icon>
        Регистрация
      </button>
    </div>
  </div>
</div>

<ng-container *ngIf="showBuyCreditsModal">
  <div class="modal-overlay" (click)="closeBuyCreditsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Купи кредити</h2>
        <button mat-icon-button (click)="closeBuyCreditsModal()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body">
        <div class="credit-packages">
          <h3>Избери от промоционалните пакети:</h3>
          
          <mat-form-field appearance="outline" class="package-select">
            <mat-label>Изберете пакет</mat-label>
            <mat-select [(ngModel)]="selectedPackage" name="packageSelect" placeholder="Изберете пакет" (selectionChange)="onPackageChange($event)">
              <mat-option *ngFor="let pkg of creditPackages; trackBy: trackByCredits" [value]="pkg">
                {{ pkg.credits }} кредита - {{ pkg.price }} лв ({{ convertBgnToEur(pkg.price) }}€)
                <span *ngIf="pkg.discount"> ({{ pkg.discount }})</span>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="selected-package" *ngIf="selectedPackage">
            <div class="package-details">
              <h4>Избран пакет:</h4>
              <div class="package-info">
                <mat-icon color="accent">stars</mat-icon>
                <span>{{ selectedPackage.credits }} кредита за {{ selectedPackage.price }} лева ({{ convertBgnToEur(selectedPackage.price) }}€)</span>
              </div>
              <p class="package-description" *ngIf="selectedPackage.description">
                {{ selectedPackage.description }}
              </p>
            </div>
          </div>
        </div>

        <div class="payment-section" *ngIf="selectedPackage">
          <h3>Картово плащане:</h3>
          <form class="payment-form">
            <mat-form-field appearance="outline">
              <mat-label>Номер на карта</mat-label>
              <input matInput [(ngModel)]="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
            </mat-form-field>

            <div class="card-details">
              <mat-form-field appearance="outline">
                <mat-label>MM/YY</mat-label>
                <input matInput [(ngModel)]="cardExpiry" name="cardExpiry" placeholder="12/25" maxlength="5">
              </mat-form-field>
              
              <mat-form-field appearance="outline">
                <mat-label>CVV</mat-label>
                <input matInput [(ngModel)]="cardCvv" name="cardCvv" placeholder="123" maxlength="3" type="password">
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline">
              <mat-label>Име на картодържателя</mat-label>
              <input matInput [(ngModel)]="cardHolderName" name="cardHolderName" placeholder="IVAN IVANOV">
            </mat-form-field>
          </form>
        </div>
      </div>

      <div class="modal-footer">
        <button mat-button (click)="closeBuyCreditsModal()">Затвори</button>
        <button mat-raised-button color="primary" 
                [disabled]="!selectedPackage || !isPaymentFormValid()"
                (click)="processPurchase()">
          Купи за {{ selectedPackage?.price || 0 }} лв ({{ selectedPackage ? convertBgnToEur(selectedPackage.price) : 0 }}€)
        </button>
      </div>
    </div>
  </div>
</ng-container>
