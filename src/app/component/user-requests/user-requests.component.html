<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
  <div style="flex: 1;"></div>
  <h4 style="margin: 0; display: flex; align-items: center; justify-content: center; flex: 1;">
    Моите Публикации
    <mat-icon style="font-size: 20px; margin-left: 6px; color: #1976d2;">campaign</mat-icon>
  </h4>
  <div style="flex: 1; display: flex; justify-content: flex-end;">
    <button mat-raised-button color="accent" (click)="openCreateRequestModal()" style="display: flex; align-items: center; gap: 6px;">
      <mat-icon>add</mat-icon>
      Добави Публикация
    </button>
  </div>
</div>
<div class="card-grid" style="display: flex; flex-wrap: wrap; gap: 24px; justify-content: center;">
  <mat-card class="example-card" *ngFor="let request of companyRequests; let i = index" appearance="outlined" style="width: 370px; min-width: 320px; max-width: 100%; box-shadow: 0 2px 12px #0002; border-radius: 14px;">
    <mat-card-header>
      <mat-icon mat-card-avatar color="primary" style="background: #e3f2fd; border-radius: 50%;">campaign</mat-icon>
      <mat-card-title style="font-weight: 600; font-size: 1.2rem;">{{ request.title }}</mat-card-title>
      <mat-card-subtitle style="font-size: 0.95rem; color: #1976d2;">{{ request.requesterName | uppercase }}</mat-card-subtitle>
    </mat-card-header>
    <div *ngIf="request.requesterCompanyId" style="display: flex; align-items: center; margin-left: 16px; margin-bottom: 4px; color: #607d8b; font-size: 0.98rem;">
      <mat-icon style="font-size: 18px; margin-right: 6px;">business</mat-icon>
      <span class="label">Фирма:&nbsp;</span>
      <span class="value" style="margin-left: 4px; font-weight: 500;">{{ getCompanyNameById(request.requesterCompanyId) || '—' }}</span>
    </div>
    <mat-card-content>
      <div class="request-details" style="display: flex; flex-direction: column; gap: 6px; margin-top: 8px;">
        <div *ngIf="request.description" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">description</mat-icon>
          <span class="label">Описание:&nbsp;</span> <span class="value">{{ request.description }}</span>
        </div>
        <div *ngIf="request.requestType" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">category</mat-icon>
          <span class="label">Тип:&nbsp;</span>
          <span class="value">
            {{ request.requestType === 'LOOKING_FOR_SERVICE' ? 'Търся услуга' :
               request.requestType === 'SHARE_SERVICE' ? 'Предлагам услуга' :
               request.requestType === 'BUY' ? 'Купувам' :
               request.requestType === 'SELL' ? 'Продавам' :
               request.requestType === 'OTHER' ? 'Друго' : request.requestType }}
          </span>
        </div>
        <div *ngIf="request.region" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">place</mat-icon>
          <span class="label">Регион:&nbsp;</span> <span class="value">{{ request.region }}</span>
        </div>
        <div *ngIf="request.capacity" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">inventory_2</mat-icon>
          <span class="label">Количество:&nbsp;</span> <span class="value">{{ request.capacity }}{{ request.unit ? ' ' + getUnitLabel(request.unit) : '' }}</span>
        </div>
        <div *ngIf="request.serviceType" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">build</mat-icon>
          <span class="label">Тип услуга:&nbsp;</span> 
          <span class="value">
            {{ request.serviceType === 'one_time' ? 'Еднократна' : (request.serviceType === 'permanent' ? 'Постоянна' : request.serviceType) }}
          </span>
        </div>
        <div *ngIf="request.priceFrom || request.priceTo" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">euro_symbol</mat-icon>
          <span class="label">Цена:&nbsp;</span>
          <span class="value">
            <ng-container *ngIf="request.priceFrom">от {{ request.priceFrom }}</ng-container>
            <ng-container *ngIf="request.priceTo">&nbsp;до {{ request.priceTo }}</ng-container>
          </span>
        </div>
        <div *ngIf="request.workMode && request.workMode !== 'nomatter'" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">work</mat-icon>
          <span class="label">Режим:&nbsp;</span> 
          <span class="value">
            {{ request.workMode === 'standard' ? 'Стандартно делнично' :
               request.workMode === 'extended' ? 'Удължено' :
               request.workMode === 'continuous' ? 'Непрекъснато' : request.workMode }}
          </span>
        </div>
        <div *ngIf="request.urgent !== undefined" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">priority_high</mat-icon>
          <span class="label">Спешно:&nbsp;</span> <span class="value">{{ request.urgent ? 'Да' : 'Не' }}</span>
        </div>
        <div *ngIf="request.availableFrom || request.availableTo" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">event</mat-icon>
          <span class="label">Период:&nbsp;</span>
          <span class="value">
            <ng-container *ngIf="request.availableFrom">от {{ request.availableFrom | formatDateArray }}</ng-container>
            <ng-container *ngIf="request.availableTo"> &nbsp;до {{ request.availableTo | formatDateArray }}</ng-container>
          </span>
        </div>
        <div *ngIf="request.responsesCount !== undefined" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">reply</mat-icon>
          <span class="label">Предложения:&nbsp;</span> 
          <span class="value" style="font-weight: 500; color: #1976d2;">{{ request.responsesCount }}</span>
        </div>
        <div *ngIf="request.files && request.files.length" class="files-row" style="display: flex; align-items: flex-start; margin-top: 8px;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b; margin-top: 2px;">attach_file</mat-icon>
          <span class="label" style="margin-right: 6px;">Файлове:</span>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
            <ng-container *ngFor="let file of request.files">
              <a *ngIf="file.isImage" [href]="file.url" target="_blank" download [title]="file.name" style="display: block; text-decoration: none;">
                <img [src]="file.url" [alt]="file.name" style="max-width: 120px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #0002; object-fit: cover; border: 1px solid #e0e0e0; margin-bottom: 4px; cursor: pointer;" />
              </a>
              <a *ngIf="!file.isImage" [href]="file.url" target="_blank" download [title]="file.name" 
                 style="display: flex; align-items: center; padding: 6px 12px; background-color: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; color: #333; text-decoration: none; margin-bottom: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <mat-icon style="color: #f44336; margin-right: 8px;">picture_as_pdf</mat-icon>
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;">{{ file.name }}</span>
              </a>
            </ng-container>
          </div>
        </div>
        
        <div *ngIf="(!request.files || !request.files.length) && getPictureUrls(request).length" class="pictures-row" style="display: flex; align-items: flex-start; margin-top: 8px;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b; margin-top: 2px;">image</mat-icon>
          <span class="label" style="margin-right: 6px;">Снимки:</span>
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <ng-container *ngFor="let pic of getPictureUrls(request)">
              <img *ngIf="pic" [src]="pictureBlobs[pic] || getPictureUrl(pic)" alt="Снимка" style="max-width: 120px; max-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #0002; object-fit: cover; border: 1px solid #e0e0e0; margin-bottom: 4px; cursor: pointer;" (click)="onImageClick(pic)" />
            </ng-container>
          </div>
        </div>
        <div *ngIf="request.status" style="display: flex; align-items: center;">
          <mat-icon style="font-size: 18px; margin-right: 6px; color: #607d8b;">info</mat-icon>
          <span class="label">Статус:</span> <span class="value">{{ request.status }}</span>
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions align="end">
      <button mat-stroked-button color="warn">Свали</button>
      <button mat-stroked-button color="primary">Редактирай</button>
      <button mat-stroked-button color="accent" (click)="viewRequestDetails(request.id)">
        <mat-icon>visibility</mat-icon>
        Виж
      </button>
    </mat-card-actions>
  </mat-card>
</div>
<div style="margin-top: auto; padding: 10px; text-align: center;">
  <button *ngIf="showCancelButton" mat-raised-button color="warn" (click)="onCancel()">
    Откажи Публикация
  </button>
  <router-outlet></router-outlet>
</div>

<div *ngIf="showImageDialog" class="image-dialog-overlay" (click)="closeImageDialog()" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;">
  <img [src]="selectedImage" alt="Голяма снимка" style="max-width: 90vw; max-height: 90vh; border-radius: 12px; box-shadow: 0 4px 32px #0008; background: #fff; padding: 8px;" (click)="$event.stopPropagation()" />
  <button (click)="closeImageDialog()" style="position: absolute; top: 32px; right: 48px; background: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 2px 8px #0003; cursor: pointer; font-size: 1.5rem; color: #1976d2;">&times;</button>
</div>
<style>
.response-btn {
  transition: box-shadow 0.2s, background 0.2s;
  border-radius: 8px;
}
.response-btn:hover {
  background: #e3f2fd !important;
  box-shadow: 0 2px 8px #1976d2aa;
}
.selected-response .mat-button-focus-overlay {
  background: #bbdefb !important;
}
.response-selected-card {
  border: 2.5px solid #1565c0 !important;
  background: #e3f2fd !important;
  box-shadow: 0 2px 12px #1976d2aa;
  transition: border 0.2s, background 0.2s;
}
</style>

<div *ngIf="showCreateRequestModal" class="modal-overlay" (click)="closeCreateRequestModal()" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 16px;">
  <div class="modal-content" (click)="$event.stopPropagation()" style="background: white; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 32px rgba(0,0,0,0.2);">
    <form [formGroup]="requestForm" (ngSubmit)="onSubmitRequest()" enctype="multipart/form-data" class="request-form">
      <mat-card style="box-shadow: none;">
        <mat-card-header style="display: flex; justify-content: space-between; align-items: center; padding: 16px;">
          <mat-card-title>Създай публикация</mat-card-title>
          <button type="button" mat-icon-button (click)="closeCreateRequestModal()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="form-fields">
            <mat-form-field appearance="fill" style="width: 100%;">
              <mat-label>Фирма</mat-label>
              <mat-select formControlName="company" required>
                <mat-option [value]="''">-- Избери Фирма --</mat-option>
                <mat-option *ngFor="let company of userCompanies" [value]="company.vatNumber">
                  {{ company.name }} ({{ company.vatNumber }})
                </mat-option>
              </mat-select>
              <mat-error *ngIf="requestForm.get('company')?.hasError('required')">Фирмата е задължителна</mat-error>
            </mat-form-field>

            <div style="display: flex; gap: 16px; width: 100%;">
              <mat-form-field appearance="fill" style="flex: 1;">
                <mat-label>Регион</mat-label>
                <input matInput formControlName="region" required maxlength="50">
                <mat-error *ngIf="requestForm.get('region')?.hasError('required')">Регионът е задължителен</mat-error>
                <mat-error *ngIf="requestForm.get('region')?.hasError('maxlength')">Регионът трябва да е до 50 символа</mat-error>
              </mat-form-field>

              <mat-form-field appearance="fill" style="flex: 1;">
                <mat-label>Тип публикация</mat-label>
                <mat-select formControlName="requestType" required>
                  <mat-option value="LOOKING_FOR_SERVICE">Търся услуга</mat-option>
                  <mat-option value="SHARE_SERVICE">Предлагам услуга</mat-option>
                  <mat-option value="BUY">Купувам</mat-option>
                  <mat-option value="SELL">Продавам</mat-option>
                  <mat-option value="OTHER">Друго</mat-option>
                </mat-select>
                <mat-error *ngIf="requestForm.get('requestType')?.hasError('required')">Типът е задължителен</mat-error>
                <mat-error *ngIf="requestForm.get('requestType')?.hasError('maxlength')">Типът трябва да е до 50 символа</mat-error>
              </mat-form-field>
            </div>

            <mat-form-field appearance="fill" style="width: 100%;">
              <mat-label>Заглавие</mat-label>
              <input matInput formControlName="title" required maxlength="255">
              <mat-error *ngIf="requestForm.get('title')?.hasError('required')">Заглавието е задължително</mat-error>
              <mat-error *ngIf="requestForm.get('title')?.hasError('maxlength')">Заглавието трябва да е до 255 символа</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" style="width: 100%;">
              <mat-label>Описание</mat-label>
              <textarea matInput formControlName="description" rows="3" required maxlength="500"></textarea>
              <mat-error *ngIf="requestForm.get('description')?.hasError('required')">Описанието е задължително</mat-error>
              <mat-error *ngIf="requestForm.get('description')?.hasError('maxlength')">Описанието трябва да е до 500 символа</mat-error>
            </mat-form-field>

            <div style="display: flex; gap: 16px; align-items: center; width: 100%;">
              <mat-form-field appearance="fill" style="flex: 1;">
                <mat-label>Необходимо след</mat-label>
                <input matInput [matDatepicker]="pickerFrom" formControlName="activeFrom" placeholder="дд.мм.гггг">
                <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
                <mat-datepicker #pickerFrom></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="fill" style="flex: 1;">
                <mat-label>Необходимо преди</mat-label>
                <input matInput [matDatepicker]="pickerTo" formControlName="activeTo" placeholder="дд.мм.гггг">
                <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
                <mat-datepicker #pickerTo></mat-datepicker>
              </mat-form-field>

              <mat-checkbox formControlName="urgent" style="margin-left: 16px;">Спешно</mat-checkbox>
            </div>

            <ng-container *ngIf="requestForm.get('requestType')?.value === 'SHARE_SERVICE' || requestForm.get('requestType')?.value === 'LOOKING_FOR_SERVICE' || requestForm.get('requestType')?.value === 'BUY' || requestForm.get('requestType')?.value === 'SELL'">
              <mat-label style="margin-top:10px;display:block;">Тип услуга</mat-label>
              <mat-radio-group formControlName="serviceType">
                <mat-radio-button value="one_time">Еднократна</mat-radio-button>
                <mat-radio-button value="permanent">Постоянна</mat-radio-button>
              </mat-radio-group>

              <div style="display: flex; gap: 16px; align-items: flex-end;">
                <mat-form-field appearance="fill" style="flex:1;">
                  <mat-label>Капацитет (брой, оборудване или количество)</mat-label>
                  <input matInput type="number" formControlName="capacity" placeholder="Въведете число">
                </mat-form-field>
                <mat-form-field appearance="fill" style="flex:1;">
                  <mat-label>Единица</mat-label>
                  <mat-select formControlName="unit">
                    <mat-option value="count">Брой</mat-option>
                    <mat-option value="box">Кашон</mat-option>
                    <mat-option value="pallet">Пале</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <mat-form-field appearance="fill" *ngIf="requestForm.get('requestType')?.value !== 'BUY' && requestForm.get('requestType')?.value !== 'SELL'">
                <mat-label>Режим работно време</mat-label>
                <mat-select formControlName="workMode">
                  <mat-option value="nomatter">Без значение</mat-option>
                  <mat-option value="standard">Стандартно делнично</mat-option>
                  <mat-option value="extended">Удължено</mat-option>
                  <mat-option value="continuous">Непрекъснато</mat-option>
                </mat-select>
              </mat-form-field>
            </ng-container>

            <ng-container *ngIf="requestForm.get('requestType')?.value === 'BUY' || requestForm.get('requestType')?.value === 'SELL'">
              <div style="display:flex; gap:10px; align-items: flex-end;">
                <mat-form-field appearance="fill" style="flex:1;">
                  <mat-label>Цена от</mat-label>
                  <input matInput type="number" formControlName="priceFrom">
                </mat-form-field>
                <mat-form-field appearance="fill" style="flex:1;">
                  <mat-label>Цена до</mat-label>
                  <input matInput type="number" formControlName="priceTo">
                </mat-form-field>
              </div>
            </ng-container>

            <div class="file-upload" style="margin: 16px 0; border: 2px solid #1976d2; padding: 15px; border-radius: 8px; background-color: #f5f9ff;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                <label style="font-weight: 600; color: #1976d2; font-size: 16px; display: flex; align-items: center;">
                  <mat-icon style="vertical-align: middle; margin-right: 8px;">attach_file</mat-icon>
                  Прикачете файлове (снимки, PDF)
                </label>
                <button mat-stroked-button color="primary" (click)="selectFiles()" type="button">
                  <mat-icon>{{ modalSelectedFiles.length > 0 ? 'add' : 'upload_file' }}</mat-icon>
                  {{ modalSelectedFiles.length > 0 ? 'Добави още файлове' : 'Избери файлове' }}
                </button>
              </div>
              
              <input 
                type="file" 
                id="modalAttachment" 
                accept="image/*,.pdf,.doc,.docx,.txt"
                (change)="onModalFileSelected($event)"
                multiple
                style="display: none;">
              
              <div class="file-hint" style="font-size: 0.85rem; margin-bottom: 10px; color: #666;">
                Можете да качите няколко файла (изображения: jpg, png, gif и документи: pdf, doc, docx, txt)
              </div>
              
              <div *ngIf="modalSelectedFiles.length > 0" style="margin: 10px 0; color: green; font-weight: 500; display: flex; align-items: center;">
                <mat-icon style="margin-right: 8px;">check_circle</mat-icon>
                Успешно избрани {{ modalSelectedFiles.length }} файла
              </div>
              
              <!-- File previews -->
              <div *ngIf="modalSelectedFiles.length > 0" style="margin: 10px 0; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; max-height: 200px; overflow-y: auto;">
                <div *ngFor="let file of modalSelectedFiles; let i = index" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid #f0f0f0;">
                  <div style="display: flex; align-items: center; overflow: hidden; flex: 1;">
                    <mat-icon [style.color]="file.type.startsWith('image/') ? '#1976d2' : '#f44336'" style="font-size: 18px; margin-right: 8px;">
                      {{ file.type.startsWith('image/') ? 'image' : 'picture_as_pdf' }}
                    </mat-icon>
                    <span style="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ file.name }}</span>
                  </div>
                  <button mat-icon-button color="warn" (click)="removeFile(i)" type="button" style="width: 24px; height: 24px; line-height: 24px;">
                    <mat-icon style="font-size: 18px;">delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <mat-form-field appearance="fill" style="width: 100%; margin-top: 18px;">
              <mat-label>Задължителни полета за да ви направят предложение</mat-label>
              <mat-select formControlName="requiredFields" multiple>
                <mat-option *ngFor="let field of ['fixedPrice','priceFrom','priceTo','availableFrom','availableTo','files']" [value]="field">
                  {{
                    field === 'fixedPrice' ? 'Фиксирана цена' :
                    field === 'priceFrom' ? 'Цена от' :
                    field === 'priceTo' ? 'Цена до' :
                    (field === 'availableFrom' && (requestForm.get('requestType')?.value === 'LOOKING_FOR_SERVICE' || requestForm.get('requestType')?.value === 'SHARE_SERVICE')) ? 'Свободен от' :
                    (field === 'availableTo' && (requestForm.get('requestType')?.value === 'LOOKING_FOR_SERVICE' || requestForm.get('requestType')?.value === 'SHARE_SERVICE')) ? 'Свободен до' :
                    field === 'availableFrom' ? 'Налично от' :
                    field === 'availableTo' ? 'Налично до' :
                    field === 'files' ? 'Файлове' : field
                  }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </mat-card-content>
        <mat-card-actions style="display: flex; justify-content: flex-end; gap: 12px; padding: 16px;">
          <button mat-button color="warn" type="button" (click)="closeCreateRequestModal()">Отказ</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="requestForm.invalid || isSubmitting">
            <span *ngIf="!isSubmitting">Създай</span>
            <span *ngIf="isSubmitting">Създава се...</span>
          </button>
        </mat-card-actions>
      </mat-card>
    </form>
  </div>
</div>