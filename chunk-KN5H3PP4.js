import{Cc as A,Fd as l,Gd as $,M as R,S as f,W as b,Z as p,a as d,b as g,i as m,l as T,q as S,t as y,uc as v}from"./chunk-BKAIPBB7.js";var k=class u{constructor(e){this.http=e}api=l.apiUrl+"/request-company";userRequestsCache$=null;apiUrl=`${this.api}`;searchRequests(e,t,r){let s={query:e,page:t.toString(),size:r.toString()};return this.http.get(`${this.apiUrl}/search`,{params:s}).pipe(y(i=>(i&&i.content&&Array.isArray(i.content)&&(i.content=i.content.map(n=>{let a=[],c=[];return Array.isArray(n.pictureUrls)?a=n.pictureUrls.map(o=>{let h=o.replace(/^[\/\\]+/,"");return o.startsWith("http")?o:`${l.apiUrl}/files/${h.replace(/\\/g,"/")}`}):Array.isArray(n.pictures)&&(a=n.pictures.map(o=>{let h=o.replace(/^[\/\\]+/,"");return o.startsWith("http")?o:`${l.apiUrl}/files/${h.replace(/\\/g,"/")}`})),Array.isArray(n.fileUrls)&&(c=n.fileUrls.map(o=>{let h=o.replace(/^[\/\\]+/,""),C=o.startsWith("http")?o:`${l.apiUrl}/files/${h.replace(/\\/g,"/")}`,U=o.split("\\").pop()?.split("/").pop()||"file",w=U.split(".").pop()?.toLowerCase()||"",E=["jpg","jpeg","png","gif","bmp","webp"].includes(w);return{url:C,isImage:E,name:U}})),g(d({},n),{pictures:a,files:c,filesCount:n.filesCount||(c.length>0?c.length:void 0)})})),i)))}getAllRequestsByUser(){return this.userRequestsCache$?this.userRequestsCache$:(this.userRequestsCache$=this.http.get(`${this.apiUrl}/user`).pipe(y(e=>{let t=e;return e&&e.content&&Array.isArray(e.content)&&(t=e.content),Array.isArray(t)?t.map(s=>s&&s.request?s.request:s&&s.id?s:null).filter(s=>s!==null):[]}),R(1)),this.userRequestsCache$)}createRequest(e){for(let t of e.entries());return this.clearUserRequestsCache(),this.http.post(`${this.apiUrl}`,e)}updateRequest(e,t){return this.clearUserRequestsCache(),this.http.put(`${this.apiUrl}/${e}`,t)}deleteRequest(e){return this.clearUserRequestsCache(),this.http.delete(`${this.apiUrl}/${e}`)}clearUserRequestsCache(){this.userRequestsCache$=null}getRequestById(e){return this.http.get(`${this.apiUrl}/${e}`).pipe(y(t=>{let r=t.request,s=[],i=[];return Array.isArray(r.pictureUrls)?s=r.pictureUrls.map(n=>{let a=n.replace(/^[\/\\]+/,"");return n.startsWith("http")?n:`${l.apiUrl}/files/${a.replace(/\\/g,"/")}`}):Array.isArray(r.pictures)&&(s=r.pictures.map(n=>{let a=n.replace(/^[\/\\]+/,"");return n.startsWith("http")?n:`${l.apiUrl}/files/${a.replace(/\\/g,"/")}`})),Array.isArray(r.fileUrls)&&(i=r.fileUrls.map(n=>{let a=n.replace(/^[\/\\]+/,""),c=n.startsWith("http")?n:`${l.apiUrl}/files/${a.replace(/\\/g,"/")}`,o=n.split("\\").pop()?.split("/").pop()||"file",h=o.split(".").pop()?.toLowerCase()||"",C=["jpg","jpeg","png","gif","bmp","webp"].includes(h);return{url:c,isImage:C,name:o}})),g(d({},t),{request:g(d({},r),{pictures:s,files:i,filesCount:r.filesCount||(i.length>0?i.length:void 0)})})}))}choiceResponse(e){return this.http.put(`${this.api}/choice`,e)}cacheUserRequests(e){this.userRequestsCache$=S(e).pipe(R(1))}isUserRequest(e){if(!this.userRequestsCache$)return!1;let t=!1;try{this.userRequestsCache$.subscribe({next:r=>{t=r.filter(n=>n&&n.id).map(n=>String(n.id)).includes(String(e))},error:r=>{t=!1}}).unsubscribe()}catch{return!1}return t}static \u0275fac=function(t){return new(t||u)(p(v))};static \u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})};var q=class u{constructor(e,t,r,s){this.http=e;this.router=t;this.companyService=r;this.companyRequestService=s;let i=localStorage.getItem("refreshToken");this.authStatusSubject.next(!!i)}apiUrl=l.apiUrl+"/auth";authStatusSubject=new T(!1);authStatus$=this.authStatusSubject.asObservable();decodedTokenCache=new Map;userEmailCache=null;register(e,t){let r=new FormData;return r.append("request",new Blob([JSON.stringify(e)],{type:"application/json"})),t&&r.append("logo",t,t.name),this.http.post(`${this.apiUrl}/register`,r)}login(e){return this.http.post(`${this.apiUrl}/login`,e,{responseType:"json"}).pipe(f(t=>{t&&t.refreshToken&&(this.setRefreshToken(t.refreshToken),this.setAccessToken(t.accessToken),this.authStatusSubject.next(!0),this.companyService.getAllCompaniesByUser().subscribe({next:r=>this.companyService.cacheUserCompanies(r),error:()=>this.companyService.clearUserCompaniesCache()}),this.companyRequestService.getAllRequestsByUser().subscribe({next:r=>{console.log("Loaded user requests for caching:",r),this.companyRequestService.cacheUserRequests(r)},error:r=>{console.error("Error loading user requests:",r),this.companyRequestService.clearUserRequestsCache()}}),this.router.navigate(["/requests"]))}))}setRefreshToken(e){window.localStorage.setItem("refreshToken",e)}setAccessToken(e){this.decodedTokenCache.clear(),this.userEmailCache=null,e!==null?window.localStorage.setItem("accessToken",e):window.localStorage.removeItem("accessToken")}getProtectedResource(){return this.http.get(`${this.apiUrl}/protected`)}refreshToken(){return this.http.post(`${this.apiUrl}/refresh-token`,{refreshToken:this.getRefreshToken()}).pipe(f(e=>{this.authStatusSubject.next(!0)}))}getRefreshToken(){return localStorage.getItem("refreshToken")}isAuthenticated(){return this.authStatusSubject.value}logout(){localStorage.removeItem("refreshToken"),localStorage.removeItem("accessToken"),this.decodedTokenCache.clear(),this.userEmailCache=null,this.clearChatFiles(),this.authStatusSubject.next(!1),this.companyService.clearUserCompaniesCache(),this.companyRequestService.clearUserRequestsCache(),this.router.navigate(["/login"])}clearChatFiles(){try{let e=[];for(let t=0;t<sessionStorage.length;t++){let r=sessionStorage.key(t);r&&r.startsWith("chat_files_")&&e.push(r)}e.forEach(t=>sessionStorage.removeItem(t)),console.log("\u{1F9F9} Cleared chat files on logout:",e.length)}catch(e){console.error("\u274C Error clearing chat files:",e)}}getAccessToken(){let e=window.localStorage.getItem("accessToken");return e||console.log("No access token found"),e}decodeToken(e){if(!e)return null;if(this.decodedTokenCache.has(e))return this.decodedTokenCache.get(e);try{let t=e.split(".");if(t.length!==3)return console.error("Invalid JWT format - not 3 parts:",t.length),null;let r=t[1],s=null;try{s=JSON.parse(atob(r))}catch{try{let n=r+"=".repeat((4-r.length%4)%4);s=JSON.parse(atob(n))}catch{try{let a=r.replace(/-/g,"+").replace(/_/g,"/"),c=a+"=".repeat((4-a.length%4)%4);s=JSON.parse(atob(c))}catch{console.warn("All decode methods failed, using fallback object"),s={sub:"petyrnyagolov@gmail.com",emailVerified:!1,exp:Math.floor(Date.now()/1e3)+3600}}}}return s&&this.decodedTokenCache.set(e,s),s}catch(t){return console.error("Error decoding token:",t),null}}isEmailVerified(){try{let e=this.getAccessToken();if(!e)return console.log("No access token found"),!1;let t=this.decodeToken(e);if(!t)return console.log("Could not decode token - treating as unverified for security"),!1;let r=t?.emailVerified===!0;return console.log("Email verified status:",r,"from token:",t),r}catch(e){return console.error("Error in isEmailVerified:",e),!1}}getUserEmail(){if(this.userEmailCache)return this.userEmailCache;try{let e=this.getAccessToken();if(!e)return null;let t=this.decodeToken(e);if(!t)return null;let r=t?.sub||null;return this.userEmailCache=r,r}catch(e){return console.error("Error in getUserEmail:",e),null}}getUserRoles(){try{let e=this.getAccessToken();if(!e)return console.log("\u{1F50D} getUserRoles: No token found"),[];let t=this.decodeToken(e);return t?(console.log("\u{1F50D} getUserRoles - Full decoded token:",t),console.log("\u{1F50D} getUserRoles - Roles from token:",t?.roles),t?.roles||[]):(console.log("\u{1F50D} getUserRoles: Token decode failed"),[])}catch(e){return console.error("Error in getUserRoles:",e),[]}}isAdmin(){let e=this.getUserRoles();return console.log("\u{1F50D} isAdmin - Checking roles:",e),console.log("\u{1F50D} isAdmin - Has ADMIN?",e.includes("ADMIN")),e.includes("ADMIN")}verifyEmailWithToken(e){return this.http.get(`${l.apiUrl}/verify/email?t=${e}`,{observe:"response"}).pipe(f(t=>{t.body?.accessToken&&(console.log("Received new access token after verification"),this.setAccessToken(t.body.accessToken),this.authStatusSubject.next(!0)),t.body?.refreshToken&&(console.log("Received new refresh token after verification"),this.setRefreshToken(t.body.refreshToken))}))}forgotPassword(e){return this.http.post(`${this.apiUrl}/forgot-password`,null,{params:{email:e}})}resetPassword(e,t){return this.http.post(`${this.apiUrl}/reset-password`,{token:e,newPassword:t})}resendVerificationLink(e){return this.http.post(`${l.apiUrl}/verify/email/resend-verification`,null,{params:{email:e}})}forceRefreshToken(){return console.log("Forcing token refresh after email verification"),this.refreshToken().pipe(f(()=>{console.log("Token refreshed successfully")}))}recheckEmailVerification(){let e=this.getAccessToken();if(!e)return!1;let r=this.decodeToken(e)?.emailVerified===!0;return console.log("Rechecked email verification:",r),r}canPerformAction(){let e=this.isAuthenticated(),t=this.isEmailVerified();return console.log("canPerformAction check:",{isAuth:e,isVerified:t}),e&&t}requireEmailVerification(){return this.canPerformAction()?new m(t=>{t.next(!0),t.complete()}):this.getUserEmail()?new m(t=>{t.next(!1),t.complete()}):new m(t=>{t.next(!1),t.complete()})}getReferralCode(){try{let e=this.getAccessToken();return e&&this.decodeToken(e)?.referralCode||null}catch(e){return console.error("Error in getReferralCode:",e),null}}getUserName(){try{let e=this.getAccessToken();if(!e)return null;let t=this.decodeToken(e);if(!t)return null;console.log("\u{1F50D} JWT Token payload:",t),console.log("\u{1F50D} Available name fields:",{name:t?.name,fullName:t?.fullName,firstName:t?.firstName,lastName:t?.lastName,username:t?.username});let r=t?.firstName,s=t?.lastName;if(r&&s)try{return r=this.fixUtf8Encoding(r),s=this.fixUtf8Encoding(s),`${r} ${s}`.trim()}catch{return console.warn("UTF-8 decoding failed, using raw values"),`${r} ${s}`.trim()}return t?.name||t?.fullName||t?.firstName||t?.username||null}catch(e){return console.error("Error in getUserName:",e),null}}fixUtf8Encoding(e){if(!e)return e;try{return decodeURIComponent(escape(e))}catch{try{let r=[];for(let s=0;s<e.length;s++)r.push(e.charCodeAt(s)&255);return new TextDecoder("utf-8").decode(new Uint8Array(r))}catch{return console.warn("UTF-8 decoding failed, using raw value:",e),e}}}getFreeCredits(){try{let e=this.getAccessToken();if(!e)return 0;let t=this.decodeToken(e);return t?(console.log("\u{1F50D} Credits in token:",{freeCredits:t?.freeCredits,credits:t?.credits,remainingCredits:t?.remainingCredits}),t?.freeCredits||t?.credits||t?.remainingCredits||0):0}catch(e){return console.error("Error in getFreeCredits:",e),0}}refreshUserInfo(){console.log("\u{1F504} Refreshing user info and credits...");let e=this.isAuthenticated();this.authStatusSubject.next(e)}getUserInfo(){return this.http.get(`${this.apiUrl}/me`)}changePassword(e,t,r){return this.http.post(`${this.apiUrl}/change-password`,{oldPassword:e,newPassword:t,confirmPassword:r})}changeEmail(e){return this.http.post(`${this.apiUrl}/change-email`,{newEmail:e})}static \u0275fac=function(t){return new(t||u)(p(v),p(A),p($),p(k))};static \u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})};export{k as a,q as b};
