import{a as v}from"./chunk-YH2VTUX2.js";import{b as C}from"./chunk-KN5H3PP4.js";import{E as m,Fd as l,S as p,W as d,Z as h,i as u,l as c,r as g,uc as b}from"./chunk-BKAIPBB7.js";var f=class n{constructor(e,t,a){this.http=e;this.authService=t;this.wsService=a;this.authService.authStatus$.subscribe(r=>{r?setTimeout(()=>this.initializeWebSocketChat(),100):(this.chatsSubject.next([]),this.unreadCountSubject.next(0))}),this.wsService.chatUpdates.subscribe(r=>{r&&r.length>0&&this.handleChatUpdates(r)})}apiUrl=l.apiUrl;unreadCountSubject=new c(0);unreadCount$=this.unreadCountSubject.asObservable();chatsSubject=new c([]);chats$=this.chatsSubject.asObservable();openChatSidebarSubject=new c(!1);openChatSidebar$=this.openChatSidebarSubject.asObservable();selectedRequestIdSubject=new c(null);selectedRequestId$=this.selectedRequestIdSubject.asObservable();fileError$=new c(null);get typing$(){return this.wsService.typingIndicators}get messages$(){return this.wsService.activeChatMessages}initializeWebSocketChat(){this.loadUserChats()}handleChatUpdates(e){let t=this.chatsSubject.value,a=!1,r=!1;if(e.forEach(s=>{let i=t.find(o=>o.requestId===s.chatId);if(i){if(i.lastMessage=s.messagePreview,i.lastMessageTime=s.timestamp,s.updateType==="NEW_MESSAGE"){let o=this.wsService.getActiveChatId();(!o||o!==s.chatId)&&(i.unreadCount=s.unreadCount||(i.unreadCount||0)+1,r=!0)}else s.updateType==="MESSAGE_READ"&&(i.unreadCount=0);a=!0}else if(s.updateType==="CHAT_CREATED"){r=!0,this.loadUserChats();return}}),a){let s=t.sort((i,o)=>new Date(o.lastMessageTime).getTime()-new Date(i.lastMessageTime).getTime());this.chatsSubject.next([...s]),this.updateTotalUnreadCount()}r&&this.openChatSidebarSubject.next(!0)}updateTotalUnreadCount(){let e=this.chatsSubject.value.reduce((t,a)=>t+(a.unreadCount||0),0);this.unreadCountSubject.next(e)}getAllUserChats(){let e={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"};return this.http.get(`${this.apiUrl}/chat/user/chats`,{headers:e}).pipe(p(t=>{console.log("\u{1F4CB} Loaded chat list:",t.length),this.chatsSubject.next(t),this.updateTotalUnreadCount()}))}getChatMessages(e){let t={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"};return this.http.get(`${this.apiUrl}/chat/${e}/messages`,{headers:t}).pipe(p(a=>{console.log("\u{1F4AC} Loaded",a.length,"messages for chat:",e)}))}getUnreadCount(e){let t={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"};return this.http.get(`${this.apiUrl}/chat/${e}/unread-count`,{headers:t})}checkAccess(e){let t={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"};return this.http.get(`${this.apiUrl}/chat/${e}/access`,{headers:t})}deleteChat(e){return this.http.delete(`${this.apiUrl}/chat/${e}`)}connectToChat(e){return new u(t=>{this.getChatMessages(e).subscribe(a=>{let r=a.map(s=>({id:s.id,message:s.message,senderName:s.senderName,senderEmail:s.senderEmail,timestamp:s.createdAt,isRead:s.isRead,messageType:s.messageType,fileName:s.fileName,fileUrl:s.fileUrl}));this.wsService.setActiveChatMessages(r),this.wsService.subscribeToChat(e),t.next(),t.complete()})})}disconnectFromChat(){this.wsService.unsubscribeFromActiveChat()}sendMessage(e,t){return this.wsService.sendChatMessage(e,t),new u(a=>{a.next({success:!0}),a.complete()})}sendTypingStatus(e,t){this.wsService.sendTypingIndicator(e,t)}markAsRead(e){this.wsService.markChatAsRead(e);let t=this.chatsSubject.value,a=t.find(r=>r.requestId===e);return a&&(a.unreadCount=0,this.chatsSubject.next([...t]),this.updateTotalUnreadCount()),new u(r=>{r.next({success:!0}),r.complete()})}sendMessageWithFiles(e,t,a){let r=new FormData;return a.forEach(s=>{r.append("files",s,s.name)}),t&&t.trim()&&r.append("message",t.trim()),this.http.post(`${this.apiUrl}/chat/${e}/files`,r).pipe(p(()=>{this.fileError$.next(null)}),m(s=>{let i=s.error?.message||"\u0413\u0440\u0435\u0448\u043A\u0430 \u043F\u0440\u0438 \u043A\u0430\u0447\u0432\u0430\u043D\u0435 \u043D\u0430 \u0444\u0430\u0439\u043B\u043E\u0432\u0435";return this.fileError$.next(i),g(()=>s)}))}downloadFile(e,t){if(e.fileUrl)return this.http.get(e.fileUrl,{responseType:"blob"});let a=`${this.apiUrl}/chat/${t}/messages/${e.id}/download`;return this.http.get(a,{responseType:"blob"})}loadUserChats(){this.authService.isAuthenticated()&&this.getAllUserChats().subscribe({next:e=>{},error:e=>{}})}loadTotalUnreadCount(){let e=this.chatsSubject.value.reduce((t,a)=>t+(a.unreadCount||0),0);this.unreadCountSubject.next(e)}refreshChats(){this.loadUserChats()}getTotalUnreadCount(){return this.chatsSubject.value.reduce((e,t)=>e+(t.unreadCount||0),0)}getChats(){return this.chatsSubject.value}isWebSocketConnected(){let e=!1;return this.wsService.isConnected$.subscribe(t=>e=t).unsubscribe(),e}openChatForRequest(e){this.selectedRequestIdSubject.next(e),this.openChatSidebarSubject.next(!0)}static \u0275fac=function(t){return new(t||n)(h(b),h(C),h(v))};static \u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})};var S=class n{constructor(e){this.http=e}api=l.apiUrl+"/request-company";createResponse(e,t,a=[]){let r=new FormData;if(r.append("responseRequestCompanyDto",new Blob([JSON.stringify(t)],{type:"application/json"})),console.log("Creating response with files:",a),a&&a.length>0)for(let s=0;s<a.length;s++)console.log(`Adding file ${s}:`,a[s].name,a[s].type,a[s].size),r.append("files",a[s],a[s].name);console.log("FormData entries:");for(let s of r.entries())console.log(s[0],s[1]instanceof File?`File: ${s[1].name}`:s[1]);return this.http.post(`${this.api}/${e}/responses`,r)}getResponsesByUser(){return this.http.get(`${this.api}/responses/user`)}updateResponse(e,t,a=[]){let r=new FormData;return r.append("responseRequestCompanyDto",new Blob([JSON.stringify(t)],{type:"application/json"})),a.forEach(s=>{r.append("files",s)}),this.http.post(`${this.api}/${e}/responses/update`,r)}updateResponseText(e,t){let a={message:t};return this.http.post(`${l.apiUrl}/responses/${e}/update-text`,a)}deleteResponse(e){return this.http.delete(`${l.apiUrl}/responses/${e}`)}confirmDeal(e){return this.http.put(`${this.api}/choice`,e)}static \u0275fac=function(t){return new(t||n)(h(b))};static \u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})};export{f as a,S as b};
