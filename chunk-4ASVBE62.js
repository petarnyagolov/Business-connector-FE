import{a as T}from"./chunk-YH2VTUX2.js";import{b as D}from"./chunk-KN5H3PP4.js";import{$a as h,Bb as n,Cd as E,Db as l,Ed as W,Fa as g,Fd as m,Hd as y,Ja as C,Od as R,Wa as p,Xa as f,Za as S,_a as v,ab as s,bb as e,g as b,lb as d,nb as k,oc as x,wa as a,yb as _}from"./chunk-BKAIPBB7.js";var I=(r,o)=>o.endpoint,w=(r,o)=>o.id;function $(r,o){r&1&&(s(0,"div",6)(1,"p"),n(2,"Testing... \u23F3"),e()())}function A(r,o){if(r&1&&(s(0,"div",17),n(1),e()),r&2){let t=k().$implicit;a(),l(" ",t.details," ")}}function U(r,o){if(r&1&&(s(0,"div",16)(1,"strong"),n(2),e(),n(3),p(4,A,2,1,"div",17),e()),r&2){let t=o.$implicit;_("color",t.success?"green":"red"),a(2),l("",t.endpoint,":"),a(),l(" ",t.message," "),a(),f(t.details?4:-1)}}function P(r,o){if(r&1&&(s(0,"div",19)(1,"strong"),n(2),e(),n(3),e()),r&2){let t=o.$implicit;a(2),l("ID #",t.id,":"),a(),l(" ",t.destination," ")}}function F(r,o){r&1&&(s(0,"div"),n(1,"No active subscriptions found"),e())}function M(r,o){if(r&1&&(s(0,"mat-card",1)(1,"h3"),n(2,"WebSocket Subscriptions"),e(),s(3,"div",18),S(4,P,4,2,"div",19,w),p(6,F,2,0,"div"),e()()),r&2){let t=k();a(4),v(t.activeSubscriptions),a(2),f(t.activeSubscriptions.length===0?6:-1)}}var N=class r{constructor(o,t){this.authService=o;this.notificationWsService=t}apiUrl=m.apiUrl;websocketUrl=m.websocketUrl;isProduction=m.production;testing=!1;testResults=[];wsConnected=!1;unreadCount=0;totalNotifications=0;totalSubscriptions=0;activeSubscriptions=[];subscriptions=[];ngOnInit(){let o=this.notificationWsService.isConnected$.subscribe(u=>{this.wsConnected=u,u?this.refreshDebugInfo():this.activeSubscriptions=[]});o&&this.subscriptions.push(o);let t=this.notificationWsService.unreadCount$?.subscribe(u=>{this.unreadCount=u});t&&this.subscriptions.push(t);let i=this.notificationWsService.notifications$?.subscribe(u=>{this.totalNotifications=u?.length||0});i&&this.subscriptions.push(i),setTimeout(()=>{this.refreshDebugInfo()},1e3);let c=setInterval(()=>{this.wsConnected&&this.refreshDebugInfo()},1e4);this.subscriptions.push({unsubscribe:()=>clearInterval(c)})}ngOnDestroy(){this.subscriptions.forEach(o=>{o&&o.unsubscribe()}),this.subscriptions=[]}checkSubscriptions(){this.refreshDebugInfo()}testAuthEndpoint(){return b(this,null,function*(){this.testing=!0;try{let o={username:"test@example.com",password:"testpassword"},t=`${m.apiUrl}/auth/login`,i=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),c=yield i.text();this.testResults.push({endpoint:"Auth Login",success:i.status!==500&&i.status!==404,message:`Status: ${i.status} ${i.statusText}`,details:i.status===400?"Expected 400 - endpoint exists but credentials invalid":c.substring(0,200)})}catch(o){this.testResults.push({endpoint:"Auth Login",success:!1,message:"Connection Error",details:o.message})}finally{this.testing=!1}})}testNotificationsEndpoint(){return b(this,null,function*(){this.testing=!0;try{let o=`${m.apiUrl}/notifications/unread`,t=this.authService.getAccessToken(),i={"Content-Type":"application/json"};t&&(i.Authorization=`Bearer ${t}`);let c=yield fetch(o,{method:"GET",headers:i}),u=yield c.text();this.testResults.push({endpoint:"Notifications (with auth)",success:c.status===200,message:`Status: ${c.status} ${c.statusText}`,details:t?u.substring(0,200):"No auth token available - please login first"})}catch(o){this.testResults.push({endpoint:"Notifications (with auth)",success:!1,message:"Connection Error",details:o.message})}finally{this.testing=!1}})}testWebSocket(){this.testing=!0;try{let o=new WebSocket(m.websocketUrl);o.onopen=()=>{this.testResults.push({endpoint:"WebSocket",success:!0,message:"Connection successful",details:"WebSocket opened successfully"}),this.testing=!1,o.close()},o.onerror=t=>{this.testResults.push({endpoint:"WebSocket",success:!1,message:"Connection failed",details:"WebSocket connection error"}),this.testing=!1},o.onclose=t=>{this.testResults.some(i=>i.endpoint==="WebSocket")||(this.testResults.push({endpoint:"WebSocket",success:t.code===1e3,message:`Connection closed: ${t.code}`,details:t.reason||"Normal closure"}),this.testing=!1)},setTimeout(()=>{this.testing&&(this.testResults.push({endpoint:"WebSocket",success:!1,message:"Connection timeout",details:"WebSocket connection timed out after 5 seconds"}),this.testing=!1,o.close())},5e3)}catch(o){this.testResults.push({endpoint:"WebSocket",success:!1,message:"WebSocket Error",details:o.message}),this.testing=!1}}testWebSocketAuth(){if(!this.authService.getAccessToken()){this.testResults.push({endpoint:"WebSocket Auth",success:!1,message:"No auth token",details:"Please login first to test authenticated WebSocket connection"});return}if(this.notificationWsService.client?.connected){console.log("\u2705 WebSocket already connected via service"),this.testResults.push({endpoint:"WebSocket Auth",success:!0,message:"Already connected",details:"WebSocket is connected via NotificationWebSocketService"});return}this.notificationWsService.connect(),setTimeout(()=>{let t=this.notificationWsService.client?.connected||!1;this.testResults.push({endpoint:"WebSocket Auth",success:t,message:t?"Connection successful":"Connection failed",details:t?"WebSocket connected with authentication":"WebSocket failed to connect - check console for errors"}),this.refreshNotificationStatus()},2e3)}refreshNotificationStatus(){let o=this.notificationWsService.client?.connected||!1}testNotificationsConnect(){if(!this.notificationWsService.client?.connected){this.testResults.push({endpoint:"Re-authenticate",success:!1,message:"WebSocket not connected",details:"Please connect WebSocket first"});return}this.notificationWsService.refreshNotifications(),this.testResults.push({endpoint:"Re-authenticate (New Architecture)",success:!0,message:"Auth message sent - backend will send List<NotificationEvent>",details:"Check console for notifications from /user/queue/notifications"})}testNotificationSound(){console.log("\u{1F3B5} Testing notification sound..."),this.notificationWsService.testNotificationSound(),this.testResults.push({endpoint:"Notification Sound Test",success:!0,message:"Sound played! \u{1F50A}",details:"Short beep sound (A5 note, 200ms)"})}forceReconnect(){console.log("\u{1F504} Forcing WebSocket reconnection..."),console.log("\u{1F504} Using disconnect/connect pattern"),this.notificationWsService.disconnect(),setTimeout(()=>{this.notificationWsService.connect()},500),this.testResults.push({endpoint:"Force Reconnect",success:!0,message:"Reconnection initiated",details:"Check console for connection events"}),setTimeout(()=>this.refreshDebugInfo(),5e3)}refreshDebugInfo(){console.log("\u{1F504} Refreshing debug information..."),this.wsConnected=this.notificationWsService.client?.connected||!1,this.activeSubscriptions=[];try{let t=this.notificationWsService.client?._stompHandler?._subscriptions||{};Object.keys(t).forEach(c=>{let u=t[c];u&&this.activeSubscriptions.push({id:c,destination:u.destination||"unknown"})})}catch(t){console.error("\u274C Error accessing subscriptions:",t)}this.totalSubscriptions=this.activeSubscriptions.length;let o=new Map;if(this.activeSubscriptions.forEach(t=>{if(t.destination!=="unknown"){let i=o.get(t.destination)||0;o.set(t.destination,i+1)}}),console.log(`\u{1F50D} Active subscriptions (${this.totalSubscriptions}):`),o.forEach((t,i)=>{let c=t>1;console.log(`  - ${i}: ${t} subscription(s) ${c?"\u26A0\uFE0F DUPLICATE!":""}`)}),console.log("\u{1F50D} Individual subscriptions:"),this.activeSubscriptions.forEach(t=>{console.log(`  - #${t.id}: ${t.destination}`)}),this.totalNotifications=this.notificationWsService.notifications$?.value?.length||0,this.unreadCount=this.notificationWsService.unreadCount$?.value||0,this.totalNotifications>0){let t=this.notificationWsService.notifications$?.value||[];console.log(`\u{1F4CA} Notifications sample (${t.length} total):`);let i=t.filter(c=>!c.isRead).length;console.log(`\u{1F4CA} Unread: ${i}/${t.length}`),console.log("\u{1F4CA} Recent notifications:"),t.slice(0,3).forEach((c,u)=>{console.log(`  ${u+1}. ID: ${c.id}, Title: ${c.title}, Read: ${c.isRead}, Date: ${c.createdAt}`)})}console.log("\u2705 Debug information refreshed")}static \u0275fac=function(t){return new(t||r)(g(D),g(T))};static \u0275cmp=C({type:r,selectors:[["app-debug"]],decls:95,vars:18,consts:[[2,"padding","20px"],[2,"margin","10px 0","padding","15px"],["mat-raised-button","","color","warn",2,"margin-top","10px",3,"click"],["mat-raised-button","","color","primary",3,"click","disabled"],["mat-raised-button","","color","accent",2,"margin-left","10px",3,"click","disabled"],["mat-raised-button","","color","warn",2,"margin-left","10px",3,"click","disabled"],[2,"margin-top","10px"],["mat-raised-button","","color","primary",2,"margin-right","10px",3,"click"],["mat-raised-button","","color","warn",3,"click"],["mat-raised-button","","color","accent",2,"margin-left","10px",3,"click"],[2,"margin-top","15px","padding","10px","background-color","#f5f5f5","border-radius","5px","font-family","monospace"],["mat-button","","color","primary",2,"margin-top","10px",3,"click"],[2,"margin","5px 0","font-family","monospace",3,"color"],[2,"margin-top","15px"],["mat-raised-button","","color","warn",2,"margin-right","10px",3,"click"],["mat-raised-button","","color","accent",3,"click"],[2,"margin","5px 0","font-family","monospace"],[2,"margin-left","20px","color","#666","font-size","12px"],[2,"font-family","monospace","background-color","#f5f5f5","padding","10px","border-radius","4px","margin-bottom","15px"],[2,"margin-bottom","4px"]],template:function(t,i){t&1&&(s(0,"div",0)(1,"h2"),n(2,"\u{1F527} Debug Information"),e(),s(3,"mat-card",1)(4,"h3"),n(5,"Environment Configuration"),e(),s(6,"div")(7,"strong"),n(8,"API URL:"),e(),n(9),e(),s(10,"div")(11,"strong"),n(12,"WebSocket URL:"),e(),n(13),e(),s(14,"div")(15,"strong"),n(16,"Production:"),e(),n(17),e(),s(18,"button",2),d("click",function(){return i.forceReconnect()}),n(19," Force Reconnect WebSocket "),e()(),s(20,"mat-card",1)(21,"h3"),n(22,"Backend Connection Tests"),e(),s(23,"button",3),d("click",function(){return i.testAuthEndpoint()}),n(24," Test Auth Endpoint "),e(),s(25,"button",4),d("click",function(){return i.testNotificationsEndpoint()}),n(26," Test Notifications Endpoint "),e(),s(27,"button",5),d("click",function(){return i.testWebSocket()}),n(28," Test WebSocket "),e(),s(29,"button",5),d("click",function(){return i.testWebSocketAuth()}),n(30," Test WebSocket (Auth) "),e(),p(31,$,3,0,"div",6),e(),s(32,"mat-card",1)(33,"h3"),n(34,"Notification Tests (New Architecture)"),e(),s(35,"button",7),d("click",function(){return i.testNotificationsConnect()}),n(36," Re-authenticate (Refresh Notifications) "),e(),s(37,"button",8),d("click",function(){return i.forceReconnect()}),n(38," Force Reconnect WebSocket "),e(),s(39,"button",9),d("click",function(){return i.testNotificationSound()}),n(40," \u{1F3B5} Test Notification Sound "),e(),s(41,"div",10)(42,"h4"),n(43,"Debug Info:"),e(),s(44,"div")(45,"strong"),n(46,"WS Connected:"),e(),n(47),e(),s(48,"div")(49,"strong"),n(50,"Subscription Channel:"),e(),n(51," /user/queue/notifications"),e(),s(52,"div")(53,"strong"),n(54,"Notifications (Local):"),e(),n(55),e(),s(56,"div")(57,"strong"),n(58,"Unread (Computed):"),e(),n(59),e(),s(60,"button",11),d("click",function(){return i.refreshDebugInfo()}),n(61," Refresh Debug Info "),e()()(),s(62,"mat-card",1)(63,"h3"),n(64,"Test Results"),e(),S(65,U,5,5,"div",12,I),e(),s(67,"mat-card",1)(68,"h3"),n(69,"Notification System Status"),e(),s(70,"div")(71,"strong"),n(72,"WebSocket Connected:"),e(),s(73,"span"),n(74),e()(),s(75,"div")(76,"strong"),n(77,"Subscriptions:"),e(),n(78),e(),s(79,"div")(80,"strong"),n(81,"Unread Count:"),e(),n(82),e(),s(83,"div")(84,"strong"),n(85,"Total Notifications:"),e(),n(86),e(),s(87,"div",13)(88,"button",7),d("click",function(){return i.refreshDebugInfo()}),n(89," Refresh Status "),e(),s(90,"button",14),d("click",function(){return i.forceReconnect()}),n(91," Force Reconnect "),e(),s(92,"button",15),d("click",function(){return i.checkSubscriptions()}),n(93," Check Subscriptions "),e()()(),p(94,M,7,1,"mat-card",1),e()),t&2&&(a(9),l(" ",i.apiUrl),a(4),l(" ",i.websocketUrl),a(4),l(" ",i.isProduction),a(6),h("disabled",i.testing),a(2),h("disabled",i.testing),a(2),h("disabled",i.testing),a(2),h("disabled",i.testing),a(2),f(i.testing?31:-1),a(16),l(" ",i.wsConnected),a(8),l(" ",i.totalNotifications),a(4),l(" ",i.unreadCount),a(6),v(i.testResults),a(8),_("color",i.wsConnected?"green":"red"),a(),l(" ",i.wsConnected?"\u2705 Connected":"\u274C Disconnected"," "),a(4),l(" ",i.totalSubscriptions),a(4),l(" ",i.unreadCount),a(4),l(" ",i.totalNotifications),a(8),f(i.wsConnected?94:-1))},dependencies:[x,W,E,R,y],encapsulation:2})};export{N as DebugComponent};
